var MAX_NUM_OF_THEME_CAN_BE_CREATED=8;
var CUSTOM_THEME_PREFIX="storeTheme";
var NewsLetterThemes={$mainDiv:null,liveOpts:null,currTheme:null,editDiv:document.createElement("div"),pwdbyCanvassUrl:"https://d3jpl91pxevbkh.cloudfront.net/hklzhl5vz/image/upload/v1361196264/pwdby_canvass.png",pwdbyCanvassLink:"http://www.canvass.in/?utm_source=emailnewsletter&utm_medium=product&utm_campaign=emailmktg",buttons:["save","bold","italic","underline","left","center","right","justify","ol","ul","fontSize","fontFamily","fontFormat","indent","outdent","link","unlink","forecolor","bgcolor","image"],init:function(b){var a=this;
a.$mainDiv=b;
a._register()
},baseTheme:{outer:{color:"black",background:"red","border-width":"0px"},footer:{"font-size":"11px",color:"#ff0000","text-align":"center"},cta:{"background-color":"#00abe0",color:"#ffffff"}},Themes:{defaultTheme:{name:"Default Theme",body:{background:"#f1f1f1","padding-top":"20px"},outer:{color:"#000000",background:"#ffffff",border:"none","border-color":"#777777"},cta:{"background-color":"#00abe0",color:"#ffffff"},footer:{background:"#777777",color:"#ffffff"}},theme11:{name:"Theme 1",body:{background:"#000000"},outer:{color:"#645234",background:"#FDF2E4",border:"solid","border-color":"#1C1C1C"},footer:{background:"#1C1C1C",color:"#999999"},cta:{"background-color":"#00abe0",color:"#ffffff"}},theme12:{name:"Theme 2",body:{background:"#E4E4E4"},outer:{color:"#0A0A0A",background:"#FFFFFF",border:"solid","border-color":"#0260B7"},footer:{background:"#0260B7",color:"#dadada"},cta:{"background-color":"#4ada3e",color:"#000000"}},theme13:{name:"Theme 3",body:{background:"#585A54"},outer:{color:"#40413E",background:"#E0E1DF",border:"solid","border-color":"#503B2A"},footer:{background:"#503B2A",color:"#87c9fc"},cta:{"background-color":"#574b4b",color:"#ffffff"}},theme14:{name:"Theme 4",body:{background:"#464232"},outer:{color:"#3A352A",background:"#FFFFFF",border:"solid","border-color":"#191919"},footer:{background:"#191919",color:"#999999"},cta:{"background-color":"#3b55e2",color:"#FFFFFF"}},theme15:{name:"Theme 5",body:{background:"#E47621"},outer:{color:"#73403D",background:"#F3B00C",border:"solid","border-color":"#B93331"},footer:{background:"#B93331",color:"#E47621"},cta:{"background-color":"#B93331",color:"#FFFFFF"}},theme16:{name:"Theme 6",body:{background:"#020169"},outer:{color:"#3A352A",background:"#FFFFFF",border:"solid","border-color":"#CB852E"},footer:{background:"#CB852E",color:"#FFFFFF"},cta:{"background-color":"#CB852E",color:"#FFFFFF"}},theme17:{name:"Theme 7",body:{background:"#2D2D29"},outer:{color:"#2D2D29",background:"#DDEBE5",border:"solid","border-color":"#215B6E"},footer:{background:"#215B6E",color:"#DDEBE5"},cta:{"background-color":"#2faed6",color:"#FFFFFF"}},theme18:{name:"Theme 8",body:{background:"#000000"},outer:{color:"#000000",background:"#FFFFFF",border:"solid","border-color":"#B80000"},footer:{background:"#b80000",color:"#FFFFFF"},cta:{"background-color":"#ff3232",color:"#000000"}},theme19:{name:"Theme 9",body:{background:"#192B20"},outer:{color:"#000000",background:"#FFFFFF",border:"solid","border-color":"#82B46F"},footer:{background:"#82B46F",color:"#FFFFFF"},cta:{"background-color":"#00c718",color:"#FFFFFF"}},theme20:{name:"Theme 10",body:{background:"#EEE8BD"},outer:{color:"#85573E",background:"#F6F5FA",border:"solid","border-color":"#B27654"},footer:{background:"#B27654",color:"#EEE8BD"},cta:{"background-color":"#85573E",color:"#FFFFFF"}},theme21:{name:"Theme 11",body:{background:"#6E8194"},outer:{color:"#3A352A",background:"#E7E6EB",border:"solid","border-color":"#232323"},footer:{background:"#232323",color:"#A8A79F"},cta:{"background-color":"#808080",color:"#f0f0f0"}},theme22:{name:"Theme 12",body:{background:"#37312B"},outer:{color:"#FFF5DC",background:"#2D2823",border:"solid","border-color":"#DC2D32"},footer:{background:"#DC2D32",color:"#352A25"},cta:{"background-color":"#FFFFFF",color:"#DC2D32"}},theme23:{name:"Theme 13",body:{background:"#F3F3F8"},outer:{color:"#3F4449",background:"#FFFFFF",border:"solid","border-color":"#EFEEF5"},footer:{background:"#EFEEF5",color:"#999999"},cta:{"background-color":"#D4D6E4",color:"#707070"}},theme24:{name:"Theme 14",body:{background:"#AA6B67"},outer:{color:"#E9BF96",background:"#230617",border:"solid","border-color":"#b68f69"},footer:{background:"#b68f69",color:"#4E2135"},cta:{"background-color":"#ffc883",color:"#472816"}},theme25:{name:"Theme 15",body:{background:"#E4E4E4"},outer:{color:"#FFFFFF",background:"#72B0DC",border:"solid","border-color":"#042655"},footer:{background:"#042655",color:"#8EA4BC"},cta:{"background-color":"#5f4bb3",color:"#8ae8fa"}},theme26:{name:"Theme 16",body:{background:"#494848"},outer:{color:"#262424",background:"#FFFFFF",border:"solid","border-color":"#C7D4E1"},footer:{background:"#C7D4E1",color:"#494848"},cta:{"background-color":"#2797ff",color:"#FFFFFF"}}},generateEditDiv:function(c){var b=this;
var a='<div><div cat=\'outer\' style=\'margin-top: -8px;margin-bottom: -10px;\'><h4>Body</h4><div class="row-fluid"><div class="control-group span6"><label class="control-label">Background Color</label><div class="controls"><div class="input-append color colorpicker" data-color=""><input type="text" class="span8" name="background" value="" ><span class="add-on"><i style="background-color: rgb(255, 146, 180)"></i></span></div></div></div><div class="control-group span6"><label class="control-label">Text Color</label><div class="controls"><div class="input-append color colorpicker" data-color=""><input type="text" class="span8" name="color" value="" ><span class="add-on"><i style="background-color: rgb(255, 146, 180)"></i></span></div></div></div><h4>Border</h4><div class="row-fluid"><div class="control-group span6"><label class="control-label">Border?</label><div class="controls"><div style="margin-top: 10px;"><div class="btn-group" data-toggle="buttons-radio"><button type="button" feedval="Yes" class="alignBtn btn btn-primary">Yes</button><button type="button" feedval="No" class="alignBtn btn btn-primary active">No</button></div><input type="checkbox" name="border" checked="true" value="solid" style="display:none"></div></div></div><div class="control-group span6" id="borderColorPicker"><label class="control-label">Border Color</label><div class="controls"><div class="input-append color colorpicker" data-color=""><input type="text" class="span8" name="border-color" value="" ><span class="add-on"><i style="background-color: rgb(255, 146, 180)"></i></span></div></div></div></div></div></div><div cat=\'footer\'style=\'margin-bottom: -13px;\'><h4>Footer</h4><div class="row-fluid"><div class="control-group span6"><label class="control-label">Background Color</label><div class="controls"><div class="input-append color colorpicker" data-color=""><input type="text" class="span8" name="background" value="" ><span class="add-on"><i style="background-color: rgb(255, 146, 180)"></i></span></div></div></div><div class="control-group span6"><label class="control-label">Text Color</label><div class="controls"><div class="input-append color colorpicker" data-color=""><input type="text" class="span8" name="color" value="" ><span class="add-on"><i style="background-color: rgb(255, 146, 180)"></i></span></div></div></div></div></div><hr style="margin: 15px 0px 10px -20px;"><div><div class="row-fluid"><div class="control-group span6" cat="body"><label class="control-label">Main Background Color</label><div class="controls"><div class="input-append color colorpicker" data-color=""><input type="text" class="span8" name="background" value="" ><span class="add-on"><i style="background-color: rgb(255, 146, 180)"></i></span></div></div></div><div class="control-group span6 hide"><label class="control-label">Save Theme</label><div class="controls"><div class="input-prepend" style="padding: 4px;min-width: 120px;margin-top: 1px;-webkit-border-radius: 4px;-moz-border-radius: 4px;border-radius: 4px;"><span class="add-on"><input type="checkbox" name="themeSave" /></span></div></div></div></div></div><div style=\'text-align:right;margin-right:10px\'><input type=\'button\' action=\'cancel\' value=\'Cancel\' class=\'btn btn-inverse\' /><input type=\'button\' action=\'apply\' value=\'Apply\' class=\'btn btn-primary\' style=\'margin-left:8px\' /></div></div>';
return a
},getTheme:function(a){var b=this;
var c={};
$.each(b.Themes,function(d,e){if(d==a){c=$.extend(true,{},b.baseTheme,e);
c.themeKey=d
}});
return c
},getThemePreview:function(a){var d=this;
var h=d.getTheme(a);
var f=new RegExp("^"+CUSTOM_THEME_PREFIX+"(\\d+)$");
var c="";
var e="";
if(f.test(a)){e='<img src="https://s3-ap-southeast-1.amazonaws.com/app-res/img/edit.jpg" class="themeEditBtn" themeId="'+f.exec(a)[1]+'" />';
c='<img class="themeRemoveBtn" src="https://s3-ap-southeast-1.amazonaws.com/app-res/img/closeImg.png" themeId="'+f.exec(a)[1]+'" />'
}var b='<div class="themeDisplayBlockPreview"><div class="prv-blk" style="background:'+h.outer.background+'"></div><div class="prv-blk" style="background:'+h.outer.color+'"></div><div class="prv-blk" style="background:'+h.footer.background+'"></div><div class="prv-blk" style="background:'+h.footer.color+'"></div>'+e+c+'<div style="clear: left"></div></div>';
return b
},extractTheme1:function(d){var c={};
var b=$(d).find("#editorContainerDiv");
var a=$(d).find(".CTA_Btn_holder a");
if(a.size()>0){if(a.find("table").length>0){c.cta={"background-color":a.find("table").css("background-color"),color:a.find("table").css("color")}
}else{c.cta={"background-color":a.css("background-color"),color:a.css("color")}
}}if(b.size()>0){c.outer={background:$(b).css("background-color"),border:$(b).css("border-style"),"border-color":rgbToHex($(b).css("border-color")),"border-width":$(b).css("border-width"),color:$(b).css("color")}
}return c
},loadTheme:function(b){var a=this;
if(b.outer){var d=a.$mainDiv.find("[cat=outer]");
var c=b.outer;
d.find("[name=background]").closest(".colorpicker").colorpicker("setValue",c.background);
d.find("[name=color]").closest(".colorpicker").colorpicker("setValue",c.color);
d.find("[name=border-color]").closest(".colorpicker").colorpicker("setValue",c["border-color"]);
d.find('[btn-group="border"]').button("setValue",c.border)
}if(b.footer){d=a.$mainDiv.find("[cat=footer]");
c=b.footer;
d.find("[name=background]").closest(".colorpicker").colorpicker("setValue",c.background);
d.find("[name=color]").closest(".colorpicker").colorpicker("setValue",c.color)
}if(b.body){d=a.$mainDiv.find("[cat=body]");
c=b.body;
d.find("[name=background]").closest(".colorpicker").colorpicker("setValue",c.background)
}},extractFromDiv:function(c,b){var a=this;
$("[cat]",c).each(function(){var d=$(this).attr("cat");
$("input",this).each(function(){b[d][$(this).attr("name")]=$(this).val()
})
});
return b
},extractFromPoupup:function(){var a=this;
var b={};
a.$mainDiv.find("[cat]").each(function(){var c=$(this).attr("cat");
b[c]={};
$(":input",this).each(function(){b[c][$(this).attr("name")]=$(this).val()
})
});
b.outer.border=a.$mainDiv.find('[btn-group="border"]  .btn.active :input').val();
b=$.extend(true,{},a.currTheme,b);
return b
},extractTheme:function(e){var a=$(e);
var d={};
var b=a.find("#editorContainerDiv");
var c=a.find(".CTA_Btn_holder a");
if(c.size()>0){if(c.find("table").length>0){d.cta={"background-color":c.find("table").css("background-color"),color:c.find("table").css("color")}
}else{d.cta={"background-color":c.css("background-color"),color:c.css("color")}
}}if(b.size()>0){d.outer={background:b.css("background-color"),border:$(b).css("border-style"),"border-color":rgbToHex($(b).css("border-color")),"border-width":$(b).css("border-width"),color:$(b).css("color")};
d.body={background:b.parents('[body-element="body"]').css("background-color")}
}return d
},_register:function(){var a=this;
a.$mainDiv.find(".colorpicker").colorpicker({format:"hex"});
a.$mainDiv.find("form").submit(function(b){b.preventDefault();
if(a.liveOpts.onaccept){a.liveOpts.onaccept(a.extractFromPoupup())
}a.$mainDiv.modal("hide");
return false
})
},editTheme:function(theme,_opts){var ME=this;
ME.liveOpts=_opts;
theme=!theme?ME.getTheme("defaultTheme"):theme;
ME.currTheme=theme;
ME.loadTheme(theme);
ME.$mainDiv.modal("show");
return;
var theme=opt.theme;
var div=ME.$mainDiv;
theme=!theme?ME.getTheme("defaultTheme"):theme;
if($.isEmptyObject(theme)){theme=ME.getTheme("defaultTheme")
}var contentDiv=$("<div/>").append(ME.generateEditDiv(theme));
$("[feedval]").click(function(e){switch($(this).attr("feedval")){case"Yes":$("#borderColorPicker *").prop("disabled",false);
$(".colorpicker","#borderColorPicker").colorpicker("enable");
$('[name="border"]').val("solid");
break;
case"No":$("#borderColorPicker *").prop("disabled",true);
$(".colorpicker","#borderColorPicker").colorpicker("disable");
$('[name="border"]').val("none");
break
}});
$('[name="border-color"]').change(function(){var colorContainer=$(this).parents(".colorpicker:first").find("i");
$(colorContainer).css("background-color",$(this).val())
});
var themeTitle=$(".modal-header h3",$(contentDiv).parents(".modal:first"));
var chkbox=$("input[name=themeSave]",contentDiv);
var heading=null;
if(opt.key!=undefined){$(chkbox).attr("checked","checked");
heading=theme.name
}else{if(opt.createNewTheme){$(chkbox).attr("checked","checked");
heading="MyTheme"+($("[theme^="+CUSTOM_THEME_PREFIX+"]").size()+1)
}else{$(chkbox).removeAttr("checked");
$(themeTitle).text("Theme editor")
}}if(heading!=null){$(themeTitle).text("");
$(themeTitle).append("<input type='text' name='themeName' value='"+heading+"'/>");
$(themeTitle).append("<div><span class='themeNameOnScreen'>"+heading+"</span>&nbsp;<a href='#' class='editThemeTriggerBtn'>(Edit)</a></div>");
$("a.editThemeTriggerBtn",themeTitle).click(function(){$(this).parents("div:first").hide();
$("input[name=themeName]").css({display:"block"}).focus()
});
$("input[name=themeName]",themeTitle).on("blur",function(){var themeNameOnScreen=$(".themeNameOnScreen",themeTitle);
$(themeNameOnScreen).parents("div:first").show();
$("input[name=themeName]").css({display:"none"});
$(themeNameOnScreen).text($("input[name=themeName]").val())
})
}$(".colorpicker",contentDiv).each(function(i,e){var input=$("input",e);
var display=$("i",e);
var content=$(input).attr("name");
var catType=$(e).parents("div[cat]:first").attr("cat");
content=content=="background"?content+="-color":content;
var element;
switch(catType){case"outer":element=$("#editorContainerDiv");
break;
case"footer":element=$("[footer-element=footer] td","#editorContainerDiv");
break;
case"body":element=$("#editorContainerDiv").parents("[body-element=body]");
break
}var color=$(element).css(content);
$(e).attr("data-color",color);
$(input).val(rgbToHex(color)).on("change",function(){var value=$(this).val();
if(/\#[0-9a-fA-F]{6}/.test(value)){var innerColor=value;
$(display).css("background-color",innerColor)
}});
$(display).css("background-color",color)
});
$(".colorpicker",contentDiv).colorpicker({format:"hex"});
$("[action]",div).click(function(){var btn=this;
var action=$(btn).attr("action");
switch(action){case"apply":theme=ME.extractFromDiv(contentDiv,theme);
if(opt.onaccept){if($("input[name=themeSave]",contentDiv).attr("checked")!=undefined){var themeName=$("input[name=themeName]",$(contentDiv).parents(".modal:first")).val();
if(themeName.trim()!=""){theme.name=themeName;
var regEx=new RegExp("^"+CUSTOM_THEME_PREFIX+"(\\d+)$");
var tid=null;
if(!opt.createNewTheme&&regEx.test(theme.themeKey)){tid=regEx.exec(theme.themeKey)[1]
}$.get("/customThemeAjax.do",{action:"SAVE_EMAIL_THEME",id:tid,json:JSON.stringify(theme)},function(data){data=eval("("+data+")");
switch(data.status){case"SUCCESS":var key=CUSTOM_THEME_PREFIX+data.json;
if(typeof(addOrChangeThemeToPanel)=="function"){addOrChangeThemeToPanel(key,theme)
}break
}})
}else{DOMElement.showMsgDialog("Fill the name or uncheck save theme checkbox.");
return
}}opt.onaccept(theme)
}break;
case"cancel":break
}$(div).modal("hide")
});
$(div).modal("show").css({width:"auto","margin-left":function(){switch(theme.outer.border){case"solid":$('[feedval="Yes"]',"#newsLetterThemeEditorDiv").click();
break;
case"none":$('[feedval="No"]',"#newsLetterThemeEditorDiv").click();
break
}$('[name="border-color"]',"#newsLetterThemeEditorDiv").val(theme.outer["border-color"]);
$('[name="border-color"]').change();
return -($(this).width()/2)
}})
}};
function rgbToHex(b){var d,c,e;
if(!b){return""
}b=b.replace(/\s/g,"");
if(/rgb\((\d+),(\d+),(\d+)\)/.test(b)){var a=/rgb\((\d+),(\d+),(\d+)\)/.exec(b);
d=a[1];
c=a[2];
e=a[3]
}else{if(/rgba\((\d+),(\d+),(\d+),(\d+)\)/.test(b)){var a=/rgba\((\d+),(\d+),(\d+),(\d+)\)/.exec(b);
d=a[1];
c=a[2];
e=a[3]
}else{d=0;
c=0;
e=0
}}return"#"+toHex(d)+toHex(c)+toHex(e)
}function toHex(a){a=parseInt(a,10);
if(isNaN(a)){return"00"
}a=Math.max(0,Math.min(a,255));
return"0123456789ABCDEF".charAt((a-a%16)/16)+"0123456789ABCDEF".charAt(a%16)
}function hexToRgb(f){if(/\#[0-9a-fA-F]{6}/.test(f)){var a=/\#([0-9a-fA-F]{2})([0-9a-fA-F]{2})([0-9a-fA-F]{2})/.exec(f);
for(var c=1;
c<=3;
c++){var h=a[c].charAt(0);
var b=a[c].charAt(1);
h=("0123456789ABCDEF".indexOf(h)!=-1)?"0123456789ABCDEF".indexOf(h):"0123456789abcdef".indexOf(h);
b=("0123456789ABCDEF".indexOf(b)!=-1)?"0123456789ABCDEF".indexOf(b):"0123456789abcdef".indexOf(b);
a[c]=(16*h)+b
}var e,d,j;
e=a[1];
d=a[2];
j=a[3];
return"rgb("+e+","+d+","+j+")"
}}function NewsletterImageLazyLoader(){this.mainDiv=null;
this.imagesDiv=null;
this.batchSize=50;
this.firstRequest=true;
var a=this;
this.loader=new CnvLazyLoader({dataSource:"/account/util/xhr/images",request:{mode:"LOAD_IMAGES",reqSource:"EMAIL_MARKETING_CAMPAIGN",batchSize:20},parseResponse1:function(b){},onBatchLoad:function(f){var m=f.images;
console.log(f);
var b=!f.campaigns?[]:f.campaigns;
function n(q){var r=[];
if(q!=undefined){for(var j=0;
j<b.length;
j++){if(q.indexOf(b[j].cId)>=0){r.push(b[j].cName)
}}}return r
}var h="";
var p;
if(!a.firstRequest&&m.length<a.batchSize){a.mainDiv.find("[load-more]").hide()
}for(var k=0;
k<m.length;
k++){var l=m[k];
var o=!l.associatedCampaigns?[]:l.associatedCampaigns;
var c="<div resourceId='"+l.resourceId+"' class='imageTile' associatedCampaigns='"+o+"'><div class='associatedCampaigns' style='display:none'>";
var d=n(o);
if(d.length>0){c+="<div style='color:red'><strong>Warning</strong> The following campaigns are using this image and will be affected.</div><ul>";
for(var e=0;
e<d.length;
e++){c+="<li>"+d[e]+"</li>"
}c+="</ul>"
}c+="</div><div class='imgIconContainer'><img class='draggable myImg' src='"+l.thumbUrl+"' originalSrc='"+l.url+"' /></div><p class='remove'><i class='fa fa-trash-o'></i></p></div>";
p=m[k].resourceId;
h+=c
}a.imagesDiv.append(h);
if(a.firstRequest==true){a.firstRequest=false
}return{prevId:p,batchSize:a.batchSize}
}})
}NewsletterImageLazyLoader.prototype={init:function(b){var a=this;
a.mainDiv=$(b);
a.imagesDiv=a.mainDiv.find("[images-div]");
a.mainDiv.on("click","[load-more]:not(.loading)",function(){var c=$(this);
c.data("actual-cnt",c.html());
c.addClass("loading").html("Loading...");
a.loader.loadNext(function(){c.removeClass("loading").html(c.data("actual-cnt"))
})
});
a.loader.init()
}};
(function(pubObj){pubObj.CTA_action=null;
pubObj.Social_action=null;
pubObj.Divider_action=null;
pubObj.emailDesigner=null;
pubObj.imageLinkHandler=null;
var activeTheme;
var bootstrapEditor;
pubObj.create=function(container,opts){var ME=this;
ME.emailDesigner=new Designer();
ME.emailDesigner.init(container,opts);
return ME.emailDesigner
};
var PersistenceManager=C$.PersistenceManager;
function _initWidgets(mainDiv){var ME=pubObj;
ME.CTA_action=new CTA_Modal($(mainDiv).find('[modal="cta-modal"]'));
ME.Social_action=new SocialWidget($(mainDiv).find('[modal="Social_modal"]'));
ME.Divider_action=new DividerWidget($(mainDiv).find('[modal="divider-modal"]'));
ME.imageLinkHandler=new ImageLinkAdder($(mainDiv).find('[modal="image-link-modal"]'),{});
var _$container=$(mainDiv).find('[editor="text-editor-container"]');
_$container.find(".btn-toolbar").attr("data-target","#"+$(mainDiv).attr("id")+" [text-editor]");
bootstrapEditor=new BootstrapEditor(_$container.find("[text-editor-blk]"),_$container.find("[text-editor]"),_$container);
$(_$container.find("[text-editor]")).wysiwyg({fileUploadError:function(){}});
window.prettyPrint&&prettyPrint()
}function TemplateChooser(){this.url="/account/activities/designers/email-template-chooser"
}TemplateChooser.prototype={open:function(messageType,associatedTemplate){associatedTemplate=!associatedTemplate?"":associatedTemplate;
if(messageType){var ME=this;
var _u=ME.url+"?msgType="+messageType;
if(associatedTemplate!=""){_u+=("&associatedTmpl="+associatedTemplate)
}C$.FramePopup.openInFullMode(_u,"Select a Template")
}},close:function(){C$.FramePopup.close()
}};
var DesignerState={_STORAGE_KEY:"_CNV_EM_DESIGNER_",designMode:"design",selectedTemplate:{},associatedTemplate:{},activeTemplate:"associated",testMailReceivers:[],save:function(){var ME=this;
PersistenceManager.save(ME._STORAGE_KEY,ME)
},reset:function(){var ME=this;
PersistenceManager.save(ME._STORAGE_KEY,{})
},load:function(){var ME=this
},unsetTemplate:function(){this.selectedTemplate={};
this.associatedTemplate={};
this.activeTemplate="associated";
this.save()
},getTemplate:function(){var ME=this;
var tmpl;
if(ME.activeTemplate=="associated"){tmpl=ME.associatedTemplate
}else{tmpl=ME.selectedTemplate
}if((tmpl.isUpload&&ME.designMode!="upload")||(!tmpl.isUpload&&ME.designMode!="design")){tmpl={}
}return tmpl
},update:function(key,val){var ME=this;
ME[key]=val;
ME.save()
}};
function TestMailHandler(designer,opts){this.$mainDiv=null;
this.opts=opts;
this.$addReceiver=null;
this.$receiverInput=null;
this.maxAllowed=3;
this.designer=designer;
this.template=null
}TestMailHandler.prototype={init:function(div,opts){var ME=this;
ME.$mainDiv=$(div);
ME.$addReceiver=ME.$mainDiv.find("[add-receiver-blk]");
ME.$receiverInput=ME.$mainDiv.find("[receiver-input-blk]:first");
ME.opts=opts;
ME.$addReceiver.click(function(){ME._addReceiver()
});
C$.afterAccountLoad(function(){ME.$mainDiv.find('[receiver-input-blk]:first [name="receivers[]"]').val(C$.AccountInfo.account.contactEmail)
});
ME.$mainDiv.on("submit","form",function(evt){evt.preventDefault();
C$.notifier.loading("Sending...");
if(ME.template!=undefined&&ME.template!=null){}var body=ME.designer._getContentAttachedWithLogo();
var subject=ME.designer._getSubject();
var receivers=[];
ME.$mainDiv.find("[receiver-input-blk]").each(function(){var val=$(this).find("input").val();
if(val!=""){receivers.push(val)
}});
var req={};
req.subject=subject;
req.body=body;
req["receivers[]"]=receivers;
DesignerState.update("testMailReceivers",receivers);
C$.post("/account/util/xhr/send-test-mail",req,function(data){C$.notifier.success("Sent Successfully");
if(ME.opts.sent){ME.opts.sent()
}});
ME.$mainDiv.modal("hide");
return false
})
},_addReceiver:function(val){var ME=this;
val=!val?"":val;
var $clone=ME.$receiverInput.clone();
var $input=$clone.find("input");
$input.removeAttr("required");
$input.val(val);
ME.$addReceiver.before($clone);
ME._updateAddBtn()
},_updateAddBtn:function(){var ME=this;
var tot=ME.$mainDiv.find("[receiver-input-blk]").length;
if(tot<ME.maxAllowed){ME.$addReceiver.show()
}else{ME.$addReceiver.hide()
}},open:function(tmpl){var ME=this;
ME.template=tmpl;
$(DesignerState.testMailReceivers).each(function(ind,val){var blk=ME.$mainDiv.find("[receiver-input-blk]")[ind];
if(blk==undefined){ME._addReceiver(val)
}else{$(blk).find("input").val(val)
}});
ME.$mainDiv.find("[receiver-input-blk]:gt(0)").each(function(){var val=$(this).find("input").val();
if(val==""){$(this).remove()
}});
ME._updateAddBtn();
ME.$mainDiv.modal("show");
ME.$mainDiv.find(':input[name="receivers[]"]:first').focus()
}};
function SaveTemplateHandler(div,opts){this.$mainDiv=div;
this.$form=div;
this.callback=null;
this.init()
}SaveTemplateHandler.prototype={init:function(){var ME=this;
ME.$form=ME.$mainDiv.find("form");
this._register()
},_register:function(){var ME=this;
ME.$form.on("submit",function(evt){evt.preventDefault();
var templateName=ME.$form.find('[name="templateName"]').val();
if(ME.callback){ME.callback(templateName)
}ME.close();
return false
})
},open:function(templateName,_cb){var ME=this;
templateName=!templateName?"":templateName;
ME.callback=_cb;
ME.$form[0].reset();
ME.$mainDiv.modal("show");
ME.$form.find('[name="templateName"]').val(templateName).focus()
},close:function(){var ME=this;
ME.$mainDiv.modal("hide")
}};
function Stack(){this.top=null;
this.count=0;
this.current=null;
this.GetCount=function(){return this.count
};
this.Push=function(data){var node={data:this.current,next:null};
this.current=data;
node.next=this.top;
this.top=node;
this.count++
};
this.Peek=function(){if(this.top===null){return null
}else{return this.top.data
}};
this.Pop=function(){if(this.top===null){return this.current
}else{var out=this.top;
this.top=this.top.next;
if(this.count>0){this.count--
}return out.data
}}
}function BlockLevelDesigner(div,opts){this.$mainDiv=div;
this.$currBlk=null;
this.currBlkOriginalState=null;
this.init()
}BlockLevelDesigner.prototype={init:function(){var ME=this;
ME._register()
},_register:function(){var ME=this;
ME.$mainDiv.find(".colorpicker").colorpicker({format:"hex"});
ME.$mainDiv.on("click","[close-btn]",function(){ME.hide()
});
ME.$mainDiv.on("click","[action]",function(){var $ele=$(this);
var act=$ele.attr("action");
switch(act){case"close":ME.hide();
break
}});
ME.$mainDiv.find("[name='padding']").change(function(){var checked=$(this).is(":checked");
var obj={name:"padding",val:checked?"8px":0};
ME._previewChange(obj)
});
ME.$mainDiv.find(".colorpicker").colorpicker().on("changeColor",function(evt){var obj={name:$(evt.target).find(":input:first").attr("name"),val:evt.color.toHex()};
ME._previewChange(obj)
})
},_previewChange:function(obj){var ME=this;
if(ME.$currBlk!=null){switch(obj.name){case"background-color":ME.$currBlk.find("table").css("background-color",obj.val);
break;
case"line-color":ME.$currBlk.find("hr").css("color",obj.val);
break;
case"padding":ME.$currBlk.find("table").css("padding",obj.val);
var $hr=ME.$currBlk.find("hr");
if($hr[0]&&obj.val!=0){$hr.css("border-right","583px solid")
}else{$hr.css("border-right","600px solid")
}break
}}},_extractData:function($ele){var ME=this;
var data={};
var $tab=$ele.find("table:first");
data["background-color"]=$tab.css("background-color");
data.padding=parseInt(""+$tab.css("padding"));
var $hr=$tab.find("hr");
if($hr[0]){data["line-color"]=$hr.css("color")
}return data
},getData:function(){},setData:function(data){var ME=this;
var $bg=ME.$mainDiv.find('[name="background-color"]').closest(".colorpicker");
var $hr=ME.$mainDiv.find('[name="line-color"]').closest(".colorpicker");
var $pd=ME.$mainDiv.find('[name="padding"]');
$hr.closest(".form-group").hide();
$bg.colorpicker("setValue",data["background-color"]);
if(data.padding>0){$pd.attr("checked","checked")
}else{$pd.removeAttr("checked")
}if(data["line-color"]){$hr.closest(".form-group").show();
$hr.colorpicker("setValue",data["line-color"])
}},edit:function(ele){var ME=this;
ME.$currBlk=$(ele);
ME.setData(ME._extractData(ME.$currBlk));
ME.$mainDiv.show("slide",{direction:"right"},500)
},hide:function(){var ME=this;
ME.$mainDiv.hide("slide",{direction:"right"},500)
},show:function(blk){var ME=this;
ME.$currBlk=$(blk);
var originalProp=ME._extractProp(ME.$currBlk);
ME.currBlkOriginalState=originalProp;
$.each(originalProp,function(key,val){switch(key){case"background-color":case"line-color":ME.$mainDiv.find('[name="'+key+'"]').parents(".colorpicker:first").colorpicker("setValue","#eeeeee");
break;
case"padding":var _f=parseInt(val);
alert(val);
ME.$mainDiv.find('[name="'+key+'"]').val(val);
break
}});
ME.$mainDiv.show("slide",{direction:"right"},500);
return;
ME.unsavedChanges=true;
$("#divider_color_changer").css("display","none");
var historyStack=new Stack();
$("#_blocks_tab a").click();
selectedBlk=$(this).parents(".block:first").find("table:first");
$(".block").find("table").css("border","none");
selectedBlk.css("border","2px solid rgb(31, 31, 31)");
if(rgbColor!=undefined&&rgbColor!=null){var bgColor=hexc(rgbColor);
if(bgColor!=undefined){$("#background_colorpicker").css("background-color",bgColor);
$("#nl_block_color_picker").val(bgColor);
var historyObj={action:aciotns.APPLY_TO_BLOCK,color:bgColor};
historyStack.Push(historyObj)
}else{$("#background_colorpicker").css("background-color","transparent");
$("#nl_block_color_picker").val("");
var historyObj={action:aciotns.APPLY_TO_BLOCK,color:"NAN"};
historyStack.Push(historyObj)
}}else{$("#background_colorpicker").css("background-color","transparent");
$("#nl_block_color_picker").val()
}$("#setting_padding").attr("disabled",false);
var divider=selectedBlk.find("hr");
if($(divider).length>0){var rgbColor=$(divider).css("color");
if(rgbColor!=undefined&&rgbColor!=null){var bgColor=hexc(rgbColor);
if(bgColor!=undefined){$("#divider_colorpicker").css("background-color",bgColor);
$("#nl_divider_color_picker").val(bgColor)
}else{$("#divider_colorpicker").css("background-color","transparent");
$("#nl_divider_color_picker").val()
}}else{$("#divider_colorpicker").css("background-color","transparent");
$("#nl_divider_color_picker").val()
}$("#divider_color_changer").css("display","");
$("#setting_padding").attr("disabled",true)
}var padding=selectedBlk.css("padding-left");
if(padding!=undefined||padding!=""){padding=padding.slice(0,padding.length-2)
}else{padding=-1
}if(padding>0){$("#setting_padding").prop("checked",true)
}else{$("#setting_padding").prop("checked",false)
}ME.$blockLevelSettingsDiv.show("slide",{direction:"right"},500)
}};
var EmailDesignerDefaultOpts={PlaceHolder:{text:'<p style="text-align:center;color:grey;margin:0px;padding:60px 0px;font-size:1em;">Enter your text here</p>',image:'<div style="padding: 58px 0px; color: gray;">Drag image here from the Images tab on the right</div>'},CUSTOM_THEME_PREFIX:"storeTheme",_template:"/res/templates/_email-designer.html",inputs:{customThemes:"/account/util/xhr/email-theme",images:"/account/util/xhr/images",whiteLabelMode:"NOT_WHITE_LABEL_EMAIL"},directUploadHandler:{templateUploader:C$.createDirectUploader("MESSAGE_TEMPLATES_BUCKET"),uploadSnapShotUploader:C$.createDirectUploader("UPLOAD_HTML_BUCKET"),_loadState:{},_completeCB:{},_convertToBlob:function(data,type){var ME=this;
var _blob=new Blob([JSON.stringify(data)],{type:"text/plain"});
return _blob
},_done:function(){var ME=this;
var flag=true;
$.each(ME._loadState,function(kev,val){if(val!=true){flag=false
}});
if(flag==true){ME._completeCB()
}return flag
},doSave:function(isUpload,data,_cb){var ME=this;
ME._loadState={};
ME._completeCB=_cb;
var saveTemplate=data.templateData;
if(saveTemplate&&saveTemplate!=null){ME._loadState.saveTemplate=false;
var _uploader=ME.templateUploader;
if(isUpload){_uploader=ME.uploadSnapShotUploader
}_uploader.afterLoad(function(){var file=ME._convertToBlob(saveTemplate.template,"text/plain");
this.upload(saveTemplate.name,file,function(){ME._loadState.saveTemplate=true;
ME._done()
})
})
}},saveSnapShot:function(isUpload,data){var ME=this;
var snapShot=data;
if(snapShot&&snapShot!=null){var uploader;
if(isUpload){uploader=ME.uploadSnapShotUploader
}else{uploader=ME.templateUploader
}uploader.afterLoad(function(){this.upload(snapShot.name,snapShot.data,function(){})
})
}}},events:{}};
C$.afterAccountLoad(function(){EmailDesignerDefaultOpts.inputs.store=C$.AccountInfo.account
});
function Designer(){this.$mainDiv=null;
this.$designTemplateDiv=null;
this.$designDiv=null;
this.$emptyPlaceholder=null;
this.$currentDraggingImg=null;
this.$emailDesignerRoot=null;
this.$emailUploadRoot=null;
this.$blockLevelSettingsDiv=null;
this.$designContainer=null;
this.$optionsContainer=null;
this.widgetCreator=null;
this.templateChooser=null;
this.initialized=false;
this.currentDesignMode="design";
this.testMailPopup=null;
this.templateSaveHandler=null;
this.customVariables=[];
this.unsavedChanges=false;
this.activeTheme=null;
this.blockLevelDesigner=null;
this.imagesInfo={}
}Designer.prototype=new C$.AbstractDesigner();
Designer.prototype.constructor=Designer;
Designer.prototype.init=function(container,opts){var ME=this;
opts=!opts?{}:opts;
opts=$.extend(true,{},EmailDesignerDefaultOpts,opts);
C$.AbstractDesigner.prototype.init.call(this,container,opts);
ME.renderComponents();
ME.widgetCreator=new MyDyanmicEditor();
ME.templateChooser=new TemplateChooser()
};
Designer.prototype.open=function(messageType){this.afterLoad(function(){var ME=this;
if(messageType){ME.opts.inputs.messageType=messageType;
ME.opts.inputs.customVariables="/account/util/xhr/custom-variables/"+messageType+"/EMAIL";
ME.renderCustomVariables()
}ME.$mainDiv.show()
})
};
Designer.prototype.show=function(){this.$mainDiv.show()
};
Designer.prototype.hide=function(){this.$mainDiv.hide()
};
Designer.prototype.preProcess=function(div){var $tabsPane=$(div).find(".options-tabs-pane");
var rndNum=Math.floor(Math.random()*new Date().getMilliseconds());
var randomId="_cnv_et_rnd_id_"+rndNum;
$(div).attr("id",randomId+"_container");
var rndFrameName="_cnv_upload_iframe_"+rndNum;
$(div).find("[upload-designer-form]").attr("target",rndFrameName);
$(div).find("[upload-designer-div] [upload-template-iframe]").attr("name",rndFrameName);
$tabsPane.find(".nav li").each(function(ind){var tab=$tabsPane.find(".tab-content .tab-pane:eq("+ind+")");
$(tab).attr("id",randomId+"_"+ind);
$(this).find("a").attr("href","#"+randomId+"_"+ind)
})
};
Designer.prototype.renderComponents=function(){var ME=this;
var $temp=$("<div />").load(ME.opts._template,function(){ME.preProcess($temp);
ME.$mainDiv=$temp;
ME.$container.append(ME.$mainDiv);
new NewsletterImageLazyLoader().init(ME.$mainDiv.find(".images-container"));
ME.blockLevelDesigner=new BlockLevelDesigner(ME.$mainDiv.find("[blocklevelsettingdiv]"));
ME.testMailPopup=new TestMailHandler(ME);
ME.templateSaveHandler=new SaveTemplateHandler(ME.$mainDiv.find('[modal="save-template-modal"]'),{});
ME.testMailPopup.init(ME.$mainDiv.find('[modal="test-mail"]'),{});
ME.$designTemplateDiv=ME.$mainDiv.find('[cnv-tmpl="email-template"]');
ME.$designContainer=ME.$mainDiv.find("[email-designer-div]");
ME.$emptyPlaceholder=ME.$designContainer.find(".empty-place-holder");
ME.$emailDesignerRoot=ME.$mainDiv.find("[email-designer-div]");
ME.$blockLevelSettingsDiv=ME.$mainDiv.find("[blocklevelsettingdiv]");
ME.$emailUploadRoot=ME.$mainDiv.find("[upload-designer-div]");
ME.$designDiv=ME.$emailDesignerRoot.find(".mainContainer");
ME._renderUserButtons();
ME.renderCustomVariables();
ME.renderThemes();
var thm=ME.$designDiv.attr("activeTheme");
thm=thm==undefined?"defaultTheme":thm;
activeTheme=NewsLetterThemes.getTheme(thm);
_initWidgets(ME.$mainDiv);
ME.register();
ME.initialized=true;
DesignerState.load();
if(ME.opts.inputs.getSavedTemplate){ME.opts.inputs.getSavedTemplate(function(tmpl){ME.setTemplate(tmpl)
})
}})
},Designer.prototype._renderUserButtons=function(){var ME=this;
var _$div=ME.$mainDiv.find("[user-button-holder]");
var btns=ME.opts.inputs.buttons;
if(btns){btns=$.isArray(btns)?btns:[btns];
$.each(btns,function(ind,val){_$div.append("<button user-btn class='btn btn-success btn-flat'>"+val+"</button>")
})
}},Designer.prototype.setTemplate=function(tmpl){var ME=this;
if(tmpl&&!$.isEmptyObject(tmpl)){DesignerState.designMode=tmpl.isUpload?"upload":"design";
DesignerState.update("associatedTemplate",tmpl);
ME._applyState(DesignerState)
}else{ME._unsetTemplate()
}return this
},Designer.prototype._applyState=function(){var ME=this;
var state=DesignerState;
ME._changeDesignMode(state.designMode,true);
var tmpl=state.getTemplate();
if(tmpl!=undefined){var selTmpl=tmpl;
if(selTmpl.url){ME.loadTemplate(selTmpl.subject,selTmpl.url)
}}};
Designer.prototype.renderCompoenets=function(){var ME=this;
ME.renderCustomVariables();
ME.renderThemes()
};
Designer.prototype.renderCustomVariables=function(){var ME=this;
function _render(vars){var $list=ME.$mainDiv.find(".custom-variables-list");
$list.empty();
$(vars).each(function(ind,custVar){var _cnt="";
var _name=(custVar.varName).replaceAll(/\s+/g,"_");
_cnt+="<li><input _customVar='true' token-ele='true' type=button class='btn btn-flat btn-default' _replacer='"+custVar.tmpReplace+"' _value='"+custVar.varValue+"' value='"+custVar.varName+"'/></li>";
$list.append(_cnt)
})
}var custVars=ME.opts.inputs.customVariables;
if(typeof custVars=="string"){C$.get(custVars,{},{success:function(data){ME.customVariables=data.variables;
_render(data.variables)
}})
}else{ME.customVariables=custVars;
_render(custVars)
}};
Designer.prototype.applyTheme=function(theme,dontTrack){var ME=this;
dontTrack=dontTrack==undefined?false:dontTrack;
if(!ME.unsavedChanges&&!dontTrack){ME.unsavedChanges=true
}theme.outer["padding-top"]="0px";
var $designDiv=ME.$emailDesignerRoot.find("#editorContainerDiv");
$designDiv.attr("activeTheme",theme.themeKey);
$designDiv.css(theme.outer);
$designDiv.parents("[body-element=body]").css(theme.body);
var footer=$("[footer-element] td",ME.$designDiv)[0];
if(footer){$(footer).css(theme.footer)
}var ctaBtns=$("[cta-element]",ME.$designDiv);
$(ctaBtns).each(function(){var ctaBtn=$(this);
if($(ctaBtn).find(">table")[0]!=undefined){$(ctaBtn).find("a").css("color",theme.cta.color);
$(ctaBtn).find("a").attr("target","_NEW");
$(ctaBtn).css("background","none");
var $tab=$(ctaBtn).find(">table");
$tab.css(theme.cta)
}else{if(ctaBtn){$(ctaBtn).css(theme.cta)
}}});
ME.activeTheme=theme
};
Designer.prototype.renderThemes=function(){var ME=this;
var MAX_THEME_NAME_SIZE=8;
var $thmList=ME.$mainDiv.find(".themesList");
var cnt="<li theme='_edit_current_theme_'><div style='float:left; width:60px; height:20px; border:1px solid rgb(219,219,219); margin-right:8px'><div style='float:left; width:14px; height:20px; text-align: center; border-right:1px solid rgb(219,219,219); background:#fff; color: black;'>?</div><div style='float:left; width:14px; height:20px; text-align: center; border-right:1px solid rgb(219,219,219); background:#fff; color: black;'>?</div><div style='float:left; width:14px; height:20px; text-align: center; border-right:1px solid rgb(219,219,219); background:#fff; color: black;'>?</div><div style='float:left; width:15px; height:20px; text-align: center; background:#fff; color: black;'>?</div><div style='clear:left'></div></div>Edit Theme</li>";
C$.get(ME.opts.inputs.customThemes,{},function(data){data=data.data;
var _thms=data.themes;
for(var i in _thms){var obj=_thms[i];
if(typeof(obj)!="function"){var ijson=eval("("+obj.themeJson+")");
NewsLetterThemes.Themes[CUSTOM_THEME_PREFIX+obj.themeId]=ijson
}}$.each(NewsLetterThemes.Themes,function(key,obj){var thmPrefix=ME.opts.CUSTOM_THEME_PREFIX;
var regEx=new RegExp("^"+thmPrefix+"(\\d+)$");
cnt+="<li theme='"+key+"' title='"+obj.name.replace("'","&#39;")+"'>"+(regEx.test(key)?obj.name.substr(0,MAX_THEME_NAME_SIZE)+(obj.name.length>MAX_THEME_NAME_SIZE?"...":""):obj.name)+NewsLetterThemes.getThemePreview(key)+"</li>"
});
$thmList.html(cnt)
});
$thmList.on("click","[theme] .themeRemoveBtn",function(event){event.stopPropagation();
var li=$(this).parents("li:first");
var cnt="Are you sure you want to remove <b>"+$(li).attr("title")+"</b> theme?";
var id=parseInt($(this).attr("themeId"));
DOMElement.showConfirm({type:"CONFIRM",content:cnt},function(accept){if(accept){$.get("/customThemeAjax.do",{action:"REMOVE_THEME",id:id},function(data){data=eval("("+data+")");
switch(data.status){case"SUCCESS":var ul=$(li).parents("ul:first");
$(li).remove();
if($("li[theme^="+CUSTOM_THEME_PREFIX+"]",ul).size()>=MAX_NUM_OF_THEME_CAN_BE_CREATED){$("li[customthemeplaceholder]",ul).addClass("hide")
}else{$("li[customthemeplaceholder]",ul).removeClass("hide")
}break;
default:$(li).show();
break
}})
}})
});
$thmList.on("click","[theme] .themeEditBtn",function(event){$(".themesList [theme].active",editorDiv).removeClass("active");
var self=this;
var li=$(self).parents("li:first");
$(li).addClass("active");
var themeKey=$(li).attr("theme");
var theme=NewsLetterThemes.getTheme(themeKey);
ME.applyTheme(theme);
try{activeTheme=$.extend(true,{},activeTheme,NewsLetterThemes.extractTheme(ME.$designContainer),theme)
}catch(e){}NewsLetterThemes.editTheme(undefined,{theme:activeTheme,key:themeKey,createNewTheme:false,onaccept:function(thm,saveOpt){ME.applyTheme(thm)
}})
});
$thmList.on("click","[theme]",function(){var $ele=this;
$thmList.find("[theme].active").removeClass("active");
$($ele).addClass("active");
var themeName=$($ele).attr("theme");
if(themeName=="_edit_current_theme_"){try{ME.activeTheme=$.extend(true,{},ME.activeTheme,NewsLetterThemes.extractTheme(ME.$designContainer))
}catch(e){}NewsLetterThemes.editTheme(ME.activeTheme,{theme:ME.activeTheme,createNewTheme:($($ele).attr("customthemeplaceholder")!=undefined),onaccept:function(thm,saveOpt){console.log("Applied Theme");
console.log(thm);
ME.activeTheme=$.extend(true,{},ME.activeTheme,thm);
ME.applyTheme(thm)
}})
}else{var theme=NewsLetterThemes.getTheme(themeName);
ME.applyTheme(theme)
}});
return cnt
};
Designer.prototype._imageResizable=function(img){var ME=this;
var _$img=$(img);
var _$div=_$img.parents(".imageHolder:first");
var pBlockDiv=_$div.parents(".block:first");
var table=$(pBlockDiv).find("table:first");
var padding=$(table).css("padding");
padding=!padding?"0px":padding;
padding=padding.slice(0,padding.length-2);
var _mxWid=padding>0?585:600;
var _tr=_$img.parents("tr:first");
var imageCount=$(".imageHolder",_tr).length;
var colCount=_tr.find("td").length;
switch(imageCount){case 1:if(colCount>1){_mxWid=_mxWid/2
}break;
case 2:_mxWid=(_mxWid-24)/imageCount;
break;
case 3:_mxWid=(_mxWid-32)/imageCount;
break
}_mxWid=Math.floor(_mxWid);
if(!ME.imagesInfo[_$img.attr("src")]){var delatTimer=window.setTimeout(function(){_$img.resizable({maxWidth:_mxWid,aspectRatio:true})
},2000);
_$img.on("load",function(){window.clearTimeout(delatTimer);
$(this).resizable({maxWidth:_mxWid,aspectRatio:true})
})
}else{_$img.resizable({maxWidth:_mxWid,aspectRatio:true})
}};
Designer.prototype._unsetTemplate=function(){var ME=this;
ME._setSubject("");
DesignerState.unsetTemplate();
switch(DesignerState.designMode){case"design":ME.$designDiv.empty().append(ME.$emptyPlaceholder);
ME._recheckFooter();
ME.applyTheme(NewsLetterThemes.getTheme("defaultTheme"),false);
break;
case"upload":ME.$emailUploadRoot.attr("state","initial");
break
}};
Designer.prototype._loadSnapshot=function(callback){var ME=this;
var cnt=ME._getContentToBe("save");
var $div=$("<div>").attr({style:"width:650px; position:fixed; top: 30%; left: 30%;z-index: -2;"}).appendTo("body");
function b64toBlob(b64Data,contentType){contentType=contentType||"";
var sliceSize=512;
var byteCharacters=atob(b64Data);
var byteArrays=[];
for(var offset=0;
offset<byteCharacters.length;
offset+=sliceSize){var slice=byteCharacters.slice(offset,offset+sliceSize);
var byteNumbers=new Array(slice.length);
for(var i=0;
i<slice.length;
i++){byteNumbers[i]=slice.charCodeAt(i)
}var byteArray=new Uint8Array(byteNumbers);
byteArrays.push(byteArray)
}var blob=new Blob(byteArrays,{type:contentType});
return blob
}if(DesignerState.designMode=="upload"){$div.html(cnt)
}else{$div.append(cnt)
}var snapShotElement=$div;
html2canvas(snapShotElement,{onrendered:function(canvas){console.log("Rendered");
var ogImgWid=snapShotElement.width();
var ogImgHei=snapShotElement.height();
var imgWid=190;
var imgHei=(imgWid/ogImgWid)*ogImgHei;
var cloneCanvas=document.createElement("canvas");
cloneCanvas.width=imgWid;
if(imgHei>174){cloneCanvas.height=174
}else{cloneCanvas.height=imgHei
}var destCtx=cloneCanvas.getContext("2d");
destCtx.drawImage(canvas,0,0,imgWid,imgHei);
snapShotElement.remove();
var contentType="image/jpeg";
var imgData=cloneCanvas.toDataURL(contentType);
imgData=imgData.replace("data:"+contentType+";base64,","");
var imageBlob=b64toBlob(imgData,contentType);
callback(imageBlob)
},useCORS:true,logging:true})
};
Designer.prototype._templateChooseHandler=function(event,data){var ME=this;
DesignerState.update("activeTemplate","selected");
switch(event){case"use":DesignerState.update("designMode",data.designMode);
ME._changeDesignMode(data.designMode,true);
ME.loadTemplate(data.subject,data.url);
var tmplId=data.templateId;
if(ME.opts.inputs.campaignType=="EMAIL_MARKETING_CAMPAIGN"){if(data.messageType!="EMAIL_MARKETING_MSG"){tmplId=0
}}else{if(data.messageType=="EMAIL_MARKETING_MSG"){tmplId=0
}}DesignerState.update("selectedTemplate",{subject:data.subject,templateName:data.templateName,url:data.url,isUpload:data.designMode=="upload",templateId:tmplId});
break;
case"create":if(data.designMode=="useAssociatedTemplate"){DesignerState.update("activeTemplate","associated");
DesignerState.update("designMode",DesignerState.associatedTemplate.isUpload?"upload":"design");
ME._changeDesignMode(DesignerState.designMode,true);
ME._applyState()
}else{DesignerState.update("designMode",data.designMode);
DesignerState.update("selectedTemplate",{isUpload:data.designMode=="upload"});
ME._changeDesignMode(DesignerState.designMode,true);
ME._unsetTemplate()
}break
}console.log(DesignerState)
};
Designer.prototype.register=function(){var ME=this;
C$.stickyBlock(ME.$mainDiv.find(".email-design-opts"));
ME.$mainDiv.find("[user-button-holder]").on("click","[user-btn]",function(){var $btn=$(this);
if(ME.opts.inputs.buttonsHandler){ME.opts.inputs.buttonsHandler($btn.text())
}});
ME.$mainDiv.on("click",".actions-list [key]",function(){var key=$(this).attr("key");
switch(key){case"PRE_VIEW":var cnt="";
var sub=ME._getSubject();
switch(DesignerState.designMode){case"upload":var _html=ME.$mainDiv.find("[upload-template-iframe]").contents().find("#HTML_CONTENT").html();
var powerByCanvass="<table class='powerByCanvass' align='center' style='width:610px;'><tr><td style='text-align:right'><a href='"+NewsLetterThemes.pwdbyCanvassLink+"'><img src='"+NewsLetterThemes.pwdbyCanvassUrl+"' width='150px' /></a></td></tr></table>";
cnt="<html><head></head><body>"+_html+powerByCanvass+"</body></html>";
break;
default:cnt=ME._getContentAttachedWithLogo("preview");
break
}localStorage.setItem("emailContent",cnt);
localStorage.setItem("emailSubject",sub);
C$.FramePopup.open("/account/activities/designers/email-review");
break;
case"TEST_MAIL":ME.testMailPopup.open();
break;
case"SAVE":case"SAVE_AS_NEW":var tmpl=$.extend(true,{},{},DesignerState.getTemplate());
if(key=="SAVE_AS_NEW"){tmpl.templateId=0;
tmpl.templateName+="- New"
}ME.templateSaveHandler.open(tmpl.templateName,function(templateName){if(templateName==undefined){return
}C$.notifier.loading("Please wait. Your template is being saved...");
tmpl.isUpload=DesignerState.designMode=="upload";
tmpl.templateName=templateName;
if(!$.isFunction(ME.opts.events.beforeSave)){C$.notifier.warning("beforeSave Method is Not Implemented")
}else{tmpl.messageType=ME.opts.inputs.messageType;
ME.opts.events.beforeSave(tmpl,function(data){tmpl.templateId=data.templateId;
tmpl.url=data.templateUrl;
DesignerState.update("selectedTemplate",tmpl);
DesignerState.update("associatedTemplate",tmpl);
var isUpload=tmpl.isUpload;
var saveObj={templateData:{name:data.templateName,template:{subject:ME._getSubject(),content:ME._getContentToBe("save")}},sentFileData:{name:data.sendTemplateName,template:{subject:ME._getSubject(),content:ME._getContentToBe("send")}}};
function _templateSaved(){C$.notifier.success("Saved Successfully");
if(ME.opts.events.onSave){ME.opts.events.onSave(tmpl)
}}ME.opts.directUploadHandler.doSave(isUpload,saveObj,function(){if(isUpload&&data.sourceFolder!=data.destinationFolder){C$.get("/account/util/xhr/copy-upload-html",{source:data.sourceFolder,destination:data.destinationFolder},function(res){_templateSaved()
})
}else{_templateSaved()
}});
ME._loadSnapshot(function(imageFile){ME.opts.directUploadHandler.saveSnapShot(isUpload,{name:data.snapShotName,data:imageFile},function(){alert("Snap shot Saved")
})
})
})
}});
break
}});
ME.$mainDiv.find("[upload-template-iframe]").load(function(){switch(DesignerState.designMode){case"upload":var sub=this.contentWindow.window.HTML_SUBJECT;
ME._setSubject(sub);
break
}});
ME.$mainDiv.on("click","[design-mode-blk] [action]",function(){var action=$(this).attr("action");
switch(action){case"CHANGE_TEMPLATE":window.cnv_childFrameCallback=function(event,data){ME.templateChooser.close();
ME._templateChooseHandler(event,data)
};
var _savedTmpl="";
if(DesignerState.associatedTemplate){_savedTmpl=DesignerState.associatedTemplate.snapShot
}ME.templateChooser.open(ME.opts.inputs.messageType,_savedTmpl);
break
}});
var _$designDiv=ME.$mainDiv.find("[upload-designer-div]");
ME.$mainDiv.on("submit","[upload-designer-form]",function(){_$designDiv.attr("state","uploaded")
});
ME.$mainDiv.on("change",'[design-mode-blk] [name="design-mode"]',function(){var mode=$(this).val().toLowerCase();
ME.currentDesignMode=mode;
DesignerState.update("designMode",mode);
ME._changeDesignMode(mode)
});
ME.$mainDiv.on("click",".email-widgets [key]",function(){var key=$(this).attr("key");
ME.$emptyPlaceholder.remove();
var _$element=$(ME.widgetCreator.createElement(key));
ME._recheckFooter();
ME._addBlock(_$element)
});
ME.$emailDesignerRoot.sortable({items:".block",handle:'[editableele="move"]',axis:"y",forceHelperSize:true,forcePlaceHolderSize:true,appendTo:ME.$emailDesignerRoot.find("#editorContainerDiv"),change:function(){ME.unsavedChanges=true
}});
NewsLetterThemes.init(ME.$mainDiv.find('[modal="theme-editor-modal"]'));
ME._registerDesignerComponents()
};
Designer.prototype._addBlock=function(element,_cb){var ME=this;
var $footer=ME.$designDiv.find("[footer-element]");
if($footer[0]){element.insertBefore($footer)
}else{ME.$designDiv.append(element)
}element.slideUp(0,function(){element.slideDown(200,function(){$("html,body").animate({scrollTop:element.offset().top},1000);
if(_cb){_cb()
}})
})
};
Designer.prototype._registerDesignerComponents=function(){var ME=this;
ME.$mainDiv.on("click",".icon_panel [editableele]",function(evt){var $ele=$(this);
var act=$(this).attr("editableele");
act=act.toLowerCase();
switch(act){case"copy":var originalDiv=$(this).parent().parent();
var $clone=ME.widgetCreator.cloneElement(originalDiv);
ME._addBlock($clone,function(){$clone.find(".imageHolder").each(function(){ME._imageResizable($(this).find("img"))
})
});
break;
case"edit":ME.blockLevelDesigner.edit($(this).parents(".block:first"));
break;
case"delete":var $blkEle=$(this).parent().parent();
bootbox.confirm({title:"Confirm",message:"<h4>Are you sure that you want remove this block?",callback:function(result){if(result){$blkEle.slideUp(500,function(){$blkEle.remove();
var cnt=ME.$designBlock.find(".block").length;
if(cnt==0){ME.$designBlock.prepend(ME.$emptyPlaceholder)
}})
}}});
break;
case"move":}});
ME.$mainDiv.on("click",".custom-variables-div .custom-variables-list li input",function(evt){evt.stopPropagation();
var $ele=$(this).clone();
$ele.attr("disabled","disabled");
$ele.removeClass("btn-default btn-flat");
bootstrapEditor.insertAtCursorPosition($("<span/>").append($ele).html())
});
ME.$mainDiv.on("click","[text-editor-div]",function(evt){evt.stopPropagation();
var $id=$(this);
$id.removeClass("empty");
bootstrapEditor.attechTo($id)
});
ME.$mainDiv.on("click",".imageHolder",function(evt){evt.preventDefault();
evt.stopPropagation();
var $ele=$(this);
var $a=$ele.find(">a:first");
if($a[0]==undefined){$a=$("<a/>");
$ele.children().first().wrap($a)
}var json={link:$a.attr("href"),alt:$a.attr("alt")};
pubObj.imageLinkHandler.setData(json);
pubObj.imageLinkHandler.show(function(res){$a=$ele.find(">a:first");
$a.attr({href:res.link,alt:res.alt})
})
});
ME.$mainDiv.on("click",".CTA_Btn_holder",function(event){event.preventDefault();
var $ele=$(this);
pubObj.CTA_action.edit($ele)
});
ME.$mainDiv.on("click",".Social_Btns_holder",function(event){event.preventDefault();
var $ele=$(this);
pubObj.Social_action.edit($ele)
});
ME.$mainDiv.on("click","[dividerType],.block table hr",function(event){event.preventDefault();
var $ele=$(this);
pubObj.Divider_action.edit($ele)
});
ME.$mainDiv.find(".images-container").on("dragover dragenter","img.draggable",function(evt){evt.preventDefault();
evt.stopPropagation()
});
ME.$mainDiv.find(".images-container").on("dragstart","img.draggable",function(evt){var image=$(evt.currentTarget);
ME.$currentDraggingImg=image;
var div=$(image).parents("div[resourceId]:first");
var resId=$(div).attr("resourceId");
var linkURL=$(image).attr("originalSrc");
evt.originalEvent.dataTransfer.effectAllowed="move";
evt.originalEvent.dataTransfer.dropEffect="copy";
evt.originalEvent.dataTransfer.setData("text/resId",resId);
evt.originalEvent.dataTransfer.setData("text/linkURL",linkURL);
evt.originalEvent.dataTransfer.setData("mycustom","this is custom value")
});
ME.$mainDiv.on("dragover dragenter",".imageHolder",function(evt){evt.preventDefault();
evt.stopPropagation()
});
ME.$mainDiv.on("drop",".imageHolder",function(event){event.preventDefault();
var $ele=$(this);
var evt=event.originalEvent;
var linkUrl=evt.dataTransfer.getData("text/linkurl");
if(linkUrl==undefined||linkUrl==""){linkUrl=evt.dataTransfer.getData("Text")
}var resId=evt.dataTransfer.getData("text/resid");
if(resId==undefined||resId.length<1||resId=="undefined"){try{resId=linkUrl.substr(linkUrl.lastIndexOf("/"));
resId=parseInt(resId.substring(resId.lastIndexOf("_")+1,resId.lastIndexOf(".")))
}catch(e){resId=0
}}var _$img=$("<img resourceId='"+resId+"' src='"+linkUrl+"' style='width:100px;height:auto;' resizable />");
var _$div=$(evt.target);
if(_$div.prop("tagName").toLowerCase()=="img"){_$div=_$div.parents(".imageHolder:first")
}_$div.removeClass("empty");
_$div.empty().append($("<div style='display:inline-block; min-height: 20px;' />").append(_$img));
ME._imageResizable(_$img);
$ele.trigger("click")
});
ME.$emailDesignerRoot.click(function(e){var _editor=$(bootstrapEditor.editor);
var inside=(_editor.is(e.target)||_editor.has(e.target).length>0);
if(!inside&&!bootstrapEditor.selectionInProgress){bootstrapEditor.removeEditor()
}})
};
Designer.prototype._recheckFooter=function(){var ME=this;
var $footer=ME.$designDiv.find("[footer-element]");
var $newFooter=$(ME.widgetCreator.createFooter(ME.opts.inputs.store));
if($footer[0]==undefined){$footer=ME.widgetCreator.createFooter(ME.opts.inputs.store);
ME.$designDiv.append($footer)
}else{if($footer.prop("tagName")=="DIV"){$newFooter.css("width","100%");
$newFooter.find("td").attr("style",$footer.attr("style"));
$newFooter.find("td").css("padding","5px");
$newFooter.insertAfter($footer);
$footer.remove();
$footer=$newFooter
}else{if($footer.text()!=$newFooter.text()){$newFooter.insertAfter($footer);
$footer.remove();
$footer=$newFooter
}}}};
Designer.prototype._changeDesignMode=function(mode,changeUI){var ME=this;
changeUI=changeUI==undefined?false:changeUI;
switch(mode){case"design":ME.$designTemplateDiv.removeClass("upload-mode").addClass("design-mode");
ME._recheckFooter();
break;
case"upload":ME.$designTemplateDiv.removeClass("design-mode").addClass("upload-mode");
break
}if(changeUI===true){var $ele=ME.$mainDiv.find('[design-mode-blk] [name="design-mode"]').parents(".btn-group");
$ele.find(".btn").removeClass("active");
$ele.find('[name="design-mode"][value="'+mode+'"]').parent(".btn").addClass("active")
}};
Designer.prototype._getContentToBe=function(type){var ME=this;
var div=$("<div />").append(ME._getPreviewContent());
ME._replaceTokens(div,type);
$("[cellpadding]",div).attr("cellpadding","0");
$("[cellspacing]",div).attr("cellspacing","0");
if(type=="send"||type=="testMail"){$("[resizable]",div).removeAttr("resizable");
$("[place-holder-state]",div).removeAttr("place-holder-state");
$("[text-editor-div]",div).removeAttr("text-editor-div");
$("[contenteditable]",div).removeAttr("contenteditable");
$("[unselectable]",div).removeAttr("unselectable");
$("[footer-element]",div).removeAttr("footer-element");
$("[style]",div).each(function(i,ele){if($(ele).css("display")=="none"){$(ele).remove()
}})
}$("[style]",$(".Social_Btns_holder",div)).each(function(i,ele){if($(ele).css("display")=="none"){$(ele).remove()
}});
$("img",div).each(function(){var wid=parseInt($(this).attr("width"));
if(!isNaN(wid)){$(this).attr("width",wid)
}var hei=parseInt($(this).attr("height"));
if(!isNaN(hei)){$(this).attr("height",hei)
}});
$(".imageHolder",div).each(function(){$(".ui-wrapper",this).css({height:"auto"});
$(".ui-wrapper img",this).css({height:"auto"});
$("img",this).css({height:"auto"});
$(this).find("div:first").css("display","inline-block");
$(this).find("img").css("display","")
});
$("#editorContainerDiv",div).children(".block").css({width:"auto",display:"block",padding:"0px"});
var cnt="";
var whiteLabelMode=ME.opts.inputs.whiteLabelMode;
if(type=="send"||type=="testMail"){cnt="<!DOCTYPE html PUBLIC '-//W3C//DTD XHTML 1.0 Strict//EN' 'http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd'><html xmlns='http://www.w3.org/1999/xhtml'><head></head><body>"+div.html();
switch(whiteLabelMode){case"WHITE_LABEL_EMAIL":break;
default:cnt+="<table align='center' style='width:610px;'><tr><td style='text-align:right'><a href='"+NewsLetterThemes.pwdbyCanvassLink+"'><img src='"+NewsLetterThemes.pwdbyCanvassUrl+"' width='150px' /></a></td></tr></table>";
break
}cnt+="</body></html>"
}else{cnt=div.html()
}return cnt
};
Designer.prototype._renderVariableList=function(){var ME=this;
var list=ME.customVariables;
ME.$designDiv.find("div[text-editor-div=editordiv] a").each(function(){var href=$(this).attr("href");
if(href!=undefined&&href!=""){href=href.replaceAll("{{","{`{`");
href=href.replaceAll("}}","`}`}");
$(this).attr("href",href)
}});
var tokenList=$("ul.tokens.tokens-list.my-list","#_custom_vars_tab_div");
if($(list).size()>0){$(tokenList).html("");
$.each(list,function(i,custVar){if(custVar.depricated){return
}var showCntClass=(custVar.varName).replaceAll(/\s+/g,"_");
var showCnt=$("<input/>",{_customVar:"true","token-ele":"true",type:"button","class":"btn "+showCntClass,_replacer:custVar.tmpReplace,_value:custVar.varValue,disabled:"disabled",value:custVar.varName});
if(custVar.isLink){$(showCnt).attr({title:"http://bit.ly/ABC123",default_replacer:custVar.improvedOlder,attechedEvent:"false","default":true})
}var replacer=custVar.tmpReplace;
replacer=replacer.replace(/\(/g,"\\(");
replacer=replacer.replace(/\)/g,"\\)");
if(custVar.improvedOlder!=null){var testContent=$("#editorContainerDiv").html().toString();
var old_template_flag=(testContent.indexOf(replacer)<0&&testContent.indexOf(custVar.improvedOlder)>=0);
if(old_template_flag){replacer=custVar.improvedOlder;
var regEx=new RegExp(replacer,"g");
$("div[text-editor-div=editordiv]","#editorContainerDiv").each(function(idx,content){$(content).html(($(content).html().toString()).replace(regEx,$("<span/>").append(showCnt).html().toString()))
})
}else{$("div[text-editor-div=editordiv]","#editorContainerDiv").each(function(idx,content){$(".canvassSetupNewSpecialLink",content).each(function(){if($(this).attr("href")==replacer){var replEle=showCnt.clone();
var text=$(this).html();
var _default=(text==custVar.improvedOlder);
text=(_default)?"http://bit.ly/ABC123":text;
$(replEle).attr({title:text,reverse:true,"default":_default,_replacer:reverse(custVar.tmpReplace),default_replacer:reverse(custVar.improvedOlder)});
$(this).after(replEle);
$(this).remove()
}})
})
}}else{regEx=new RegExp(replacer,"gi");
ME.$designDiv.find("div[text-editor-div=editordiv]").each(function(idx,content){$(content).html(($(content).html().toString()).replace(regEx,$("<span/>").append(showCnt).html()))
})
}})
}$("div[text-editor-div=editordiv]","#editorContainerDiv").find("a").each(function(){var href=$(this).attr("href");
if(href!=undefined&&href!=""){href=href.replaceAll("{`{`","{{");
href=href.replaceAll("`}`}","}}");
$(this).attr("href",href)
}})
};
Designer.prototype._getContentAttachedWithLogo=function(){var ME=this;
var tempDiv=$("<div />").append(ME._getPreviewContent());
ME._replaceTokens(tempDiv,"preview");
var cnt="<html><head></head><body>"+tempDiv.html()+"<table align='center' style='width:610px;'><tr><td style='text-align:right'><a href='"+NewsLetterThemes.pwdbyCanvassLink+"'><img src='"+NewsLetterThemes.pwdbyCanvassUrl+"' width='150px' /></a></td></tr></table></body></html>";
return cnt
};
Designer.prototype._getPreviewContent=function(){var ME=this;
switch(DesignerState.designMode){case"design":var div=ME.$mainDiv.find("#editorOuterContainerDiv").clone();
$('[contenteditable="true"]',div).attr("contenteditable","false");
$(".block",div).find("table").css("border","none");
$("#editorContainerDiv",div).find("table[blocktype='IMAGE_AND_TEXT']").each(function(ind,ele){var isEmpty=true;
if($(ele).find("img").length!=0){$(ele).find("img").attr("align","absbottom");
isEmpty=false
}else{if($(ele).find("[_customvar]").length!=0){isEmpty=false
}else{if($(ele).find('[text-editor-div="editordiv"]').text().replace(/\s|Enter your text here/g,"").length!=0){isEmpty=false
}else{if(isEmpty){$(this).parent("div").eq(0).remove()
}}}}});
$("#editorContainerDiv",div).find("table[blocktype='ONLY_IMAGE']").each(function(ind,ele){var isEmpty=true;
if($(ele).find("img").length!=0){$(ele).find("img").attr("align","absbottom");
isEmpty=false
}if(isEmpty){$(this).parent("div").eq(0).remove()
}});
$("#editorContainerDiv",div).find("table[blocktype='ONLY_TEXT']").each(function(ind,ele){var isEmpty=true;
if($(ele).find('[text-editor-div="editordiv"]').text().replace(/\s|Enter your text here/g,"").length!=0){isEmpty=false
}else{if($(ele).find("[_customvar]").length!=0){isEmpty=false
}else{if(isEmpty){$(this).parent("div").eq(0).remove()
}}}});
$("#editorContainerDiv",div).find("table[blocktype='TWO_IMAGE']").each(function(ind,ele){var isEmpty=true;
$(this).find("tr:first").find("img").each(function(ind,ele){if($(ele).length!=0){$(ele).attr("align","absbottom");
isEmpty=false
}});
$(this).find("tr").eq(1).find('[text-editor-div="editordiv"]').each(function(ind,ele){if($(ele).text().replace(/\s|Enter your text here/g,"").length!=0){isEmpty=false
}else{if($(ele).find("[_customvar]").length!=0){isEmpty=false
}}});
if(isEmpty){$(this).parent("div").eq(0).remove()
}});
$("#editorContainerDiv",div).find("table[blocktype='THREE_IMAGE']").each(function(ind,ele){var isEmpty=true;
$(this).find("tr:first").find("img").each(function(ind,ele){if($(ele).length!=0){$(ele).attr("align","absbottom");
isEmpty=false
}});
$(this).find("tr").eq(1).find('[text-editor-div="editordiv"]').each(function(ind,ele){if($(ele).text().replace(/\s|Enter your text here/g,"").length!=0){isEmpty=false
}else{if($(ele).find("[_customvar]").length!=0){isEmpty=false
}}});
if(isEmpty){$(this).parent("div").eq(0).remove()
}});
$("#editorContainerDiv",div).find("[dividerType='Space']").each(function(ind,ele){var table=$(ele).parents("table:first");
$(table).css("padding","0px")
});
$(div).find('[text-editor-div="editordiv"]').css("min-width","100px");
$(".mainContainer",div).removeClass("mainContainer");
$(div).css({width:"auto","over-flow":"hidden",height:"400px"});
$(".hide",div).remove();
$("[editableEle]",div).remove();
$(".ui-resizable-handle",div).remove();
$(".resize-symbol",div).remove();
$(".empty-place-holder[empty-place-holder]",div).remove();
$("[style]",$(".Social_Btns_holder",div)).each(function(i,ele){if($(ele).css("display")=="none"){$(ele).remove()
}});
var wrapper=$("[body-element]","#editorOuterContainerDiv");
var table=$("#editorContainerDiv",div).parents("table:first");
var backTable="<table width='100%' cellpadding='0' cellspacing='0' border='0'><tr><td></td>";
var cnt=$("<td/>",{"body-element":"body",align:"center",style:""}).css({padding:"20px 20px","background-color":$(wrapper).css("background-color")}).append(table);
cnt=$("<table cellpadding='0' cellspacing='0' border='0' style='width:100%;margin:0px auto'/>").append($("<tr/>").append(cnt));
$(".imageHolder",table).each(function(){$(".ui-wrapper",this).css({height:"auto"});
$(".ui-wrapper img",this).css({height:"auto"});
$("img",this).css({height:"auto"})
});
$("#editorContainerDiv",table).children(".block").css({width:"auto",display:"block",padding:"0px"});
break;
case"upload":cnt=ME.$emailUploadRoot.find("iframe").contents().find("#HTML_CONTENT").html();
break
}return($("<div/>").append(cnt).html())
};
Designer.prototype._registerLoadedTemplate=function(templateData){var ME=this;
$("[resizable]",$tmpDiv).each(function(){var ui=$(this).parents(".ui-wrapper:first");
var block=$(this).parents(".block:first");
var table=$(block).find("table:first");
var padding=$(table).css("padding");
padding=padding.slice(0,padding.length-2);
var div=$(ui).parents(":not(.ui-wrapper):first");
$(div).html($(ui).html());
var img=$("[resizable]",div);
var _tr=$(img).parents("tr:first");
var nCells=$(_tr).children("td").length;
_tr.find(".imageHolder").each(function(){$(this).find("div:first").css("display","inline-block")
});
var _mxWid=585;
if(padding>0){_mxWid=585
}else{_mxWid=600
}var imgs;
if(nCells>1){imgs=$(".imageHolder",_tr).length;
if(imgs>1){switch(imgs){case 2:_mxWid=(_mxWid-24)/imgs;
break;
case 3:_mxWid=(_mxWid-32)/imgs;
_mxWid=Math.floor(_mxWid);
break
}}else{_mxWid=_mxWid/2
}}$(img).resizable({maxWidth:_mxWid,aspectRatio:true});
$(".ui-wrapper",div).css({width:$(ui).width()+"px"});
$("img",div).css({width:$(ui).width()+"px"});
$(".ui-wrapper",div).css({overflow:"visible",height:"auto"});
$(".ui-wrapper img",div).css({display:"inline"});
$(".ui-resizable-se",div).after($("<div/>",{"class":"resize-symbol"}).append($("<img/>",{src:"/res/img/final.png",height:"25",width:"25"})));
if($("img",this).size()==0){$(this).addClass("empty")
}$(img).parent(".ui-wrapper:first").css({height:"auto",position:"relative"})
});
var SOCIAL_LINKS=null;
if(SOCIAL_LINKS==null){loadDefaultSocialLinks(function(){replaceDefaultSocialLinks()
})
}else{replaceDefaultSocialLinks()
}};
Designer.prototype._preProcessLoadedTemplate=function(templateData){var ME=this;
var $tmpDiv=$("<div />").append(templateData);
var _$cont=$tmpDiv.find("#editorContainerDiv");
var tag=_$cont.prop("tagName");
if(tag=="DIV"){var _$td=_$cont.parents("td:first");
_$td.attr("id",_$cont.attr("id"));
_$td.attr("activetheme",_$cont.attr("activetheme"));
_$td.attr("activetheme",_$cont.attr("activetheme"));
_$td.attr("style",_$cont.attr("style"));
_$td.html(_$cont.html())
}var $td=$tmpDiv.parent("td:first");
$td.attr({style:$tmpDiv.attr("style"),"class":$tmpDiv.attr("class"),id:$tmpDiv.attr("id")}).html($tmpDiv.html());
if($td.length==1){$tmpDiv=$td
}$(".miniColors-triggerWrap",$tmpDiv).remove();
$(".colorChanger",$tmpDiv).remove();
$(".ui-resizable-handle",$tmpDiv).remove();
$(".nicEdit-panel",$tmpDiv).remove();
$(".nicEdit-panelContain",$tmpDiv).remove();
$("[text-editor-div]",$tmpDiv).css({"line-height":"initial","max-width":"auto"});
$("[text-editor-div]",$tmpDiv).each(function(){if($(this).html().length<1){$(this).addClass("empty")
}});
$(".imageHolder",$tmpDiv).each(function(){var _$img=$(this).find("img:first");
_$img.unwrap(".ui-wrapper")
});
$("div.block",$tmpDiv).each(function(){$(".dragHandler,.delete,.close,.setting,.copyBlock",this).remove();
$(".icon_panel",this).remove();
var margin=$(this).css("margin-top");
margin=margin.slice(0,margin.length-2);
$(this).css("margin","0px");
if(margin>0){if($(this).find("hr").length>0){$(this).find("table:first").css("padding","8px");
$(this).find("hr").css("border-width","medium 583px medium medium")
}else{$(this).find("table:first").css("padding","8px")
}}$(this).css("position","relative");
$(this).find("table").css("border-collapse","separate");
$(this).prepend(ME.widgetCreator.iconPanel)
});
$("[footer-element]",$tmpDiv).css({"border-spacing":"0px",padding:"0px"});
var footerRow=$("[footer-element]",$tmpDiv).find("td:first");
$(footerRow).css({padding:"5px",margin:"0px","border-spacing":"0px"});
var thm=_$cont.attr("activeTheme");
if(thm==undefined){thm="defaultTheme"
}ME.activeTheme=NewsLetterThemes.getTheme(thm);
return $tmpDiv.html()
};
Designer.prototype._setSubject=function(subject){var ME=this;
ME.$mainDiv.find('[name="subject"]').val(subject)
};
Designer.prototype._getSubject=function(){var ME=this;
return ME.$mainDiv.find('[name="subject"]').val()
};
Designer.prototype._setTemplate=function(template){var ME=this;
switch(DesignerState.designMode){case"design":ME.$emailDesignerRoot.find("#editorOuterContainerDiv").html(template.content);
ME._setSubject(template.subject);
ME.$designDiv=ME.$emailDesignerRoot.find("#editorContainerDiv");
ME.$designDiv.css("padding",0);
ME.$designDiv.find(".imageHolder").each(function(){var _$img=$(this).find("img");
ME._imageResizable(_$img)
});
ME._renderVariableList();
ME._recheckFooter();
break;
case"upload":var $uploadDiv=ME.$mainDiv.find("[upload-designer-div]");
$uploadDiv.find("[upload-template-iframe]").attr("src","/account/util/show-upload-html?url="+template.url);
$uploadDiv.attr("state","uploaded");
break
}};
Designer.prototype.loadTemplate=function(templateSubject,templateUrl,defaultTemplate){var ME=this;
defaultTemplate=defaultTemplate==undefined?false:defaultTemplate;
switch(DesignerState.designMode){case"design":ME.$designContainer.addClass("cnv_loading");
C$.get("/account/util/xhr/email-template",{template_url:templateUrl},function(data){ME.$designContainer.removeClass("cnv_loading");
var templateData=data.data.template;
if(templateData.subject==undefined||templateData.subject==""){templateData.subject=templateSubject
}if(!defaultTemplate){templateData.content=ME._preProcessLoadedTemplate(templateData.content)
}ME._setTemplate(templateData)
});
break;
case"upload":ME.$emailUploadRoot.addClass("cnv_loading");
ME.$emailUploadRoot.find("iframe").one("load",function(){ME.$emailUploadRoot.removeClass("cnv_loading")
});
ME._setTemplate({url:templateUrl});
break
}};
Designer.prototype._replaceTokens=function(content,replaceFor){$("[token-ele],[_customVar]",content).each(function(){var self=this;
var replaceCnt;
var html=$(self).attr("title");
if(replaceFor=="preview"||replaceFor=="testMail"){replaceCnt=$(self).attr("_value")
}else{if(replaceFor=="send"||replaceFor=="save"){replaceCnt=$(self).attr("_replacer");
html=$(self).attr("default")=="true"?$(self).attr("default_replacer"):$(self).attr("title")
}}if($(self).attr("title")!=undefined){var a=$("<a/>",{html:html,target:"_blank","class":"canvassSetupNewSpecialLink",href:replaceCnt});
replaceCnt=$("<span/>").append(a).html()
}$(self).before(replaceCnt);
$(self).remove()
})
};
function MyDyanmicEditor(){this.elementType="";
this.ElementTypes={TEXT:{},TEXT_WITH_IMAGE:{},IMAGE_WITH_TEXT:{}},this.iconPanel="<div class='icon_panel'><span editableEle='move' title='Move'><i class='fa fa-arrows'></i></span><span editableEle='copy' title='Copy'><i class='fa fa-copy'></i></span><span editableEle='edit' title='Edit Block Settings'><i class='fa fa-edit'></i></span><span editableEle='delete' title='Remove'><i class='fa fa-trash'></i></span></div>"
}MyDyanmicEditor.prototype.createTableCell=function(){var td=document.createElement("td");
return td
};
MyDyanmicEditor.prototype.createFooter=function(store){var tab=document.createElement("table");
var tr=document.createElement("tr");
var td=document.createElement("td");
$(tab).attr("footer-element","footer");
$(tab).css({width:"100%","border-spacing":"0px"});
var innerDiv=document.createElement("div");
$(td).css({padding:"5px","text-align":"center"});
var setFooterTheme=function(){if(activeTheme.footer!=null){$(td).css(activeTheme.footer)
}else{setTimeout(setFooterTheme,200)
}};
setFooterTheme();
if(store==undefined){C$.afterAccountLoad(function(){store=C$.AccountInfo.account;
$(innerDiv).html("(c) "+store.storeName+" | "+store.buildingName+" | "+store.areaName+" | "+store.city+" "+store.pincode)
})
}else{store=C$.AccountInfo.account;
$(innerDiv).html("(c) "+store.storeName+" | "+store.buildingName+" | "+store.areaName+" | "+store.city+" "+store.pincode)
}$(td).append(innerDiv);
$(tr).append(td);
$(tab).append(tr);
return tab
};
MyDyanmicEditor.prototype.cloneElement=function(sourceElement){var clonedEle=$(sourceElement).clone();
$(".imageHolder",clonedEle).each(function(){var ele=this;
var $img=$("[resizable]",ele);
$img.unwrap(".ui-wrapper").parent().empty().append($img);
$img.data("actual-dim",$img.width()+","+$img.height());
try{$img.resizable("destroy")
}catch(e){}});
clonedEle.find(".clonedEle").remove();
$(clonedEle).find("[text-editor-div=editordiv]").each(function(ind,ele){$(ele).removeAttr("id")
});
return clonedEle
};
MyDyanmicEditor.prototype.createTextBlock=function(){var textDiv=document.createElement("div");
$(textDiv).attr({"text-editor-div":"editordiv"});
$(textDiv).css({width:"auto",padding:"0px","line-height":"initial","word-break":"break-word","word-wrap":"break-word"});
$(textDiv).addClass("element empty");
return textDiv
};
MyDyanmicEditor.prototype.createImageBlock=function(){var imgDiv=document.createElement("div");
$(imgDiv).addClass("imageHolder element empty").css("text-align","center");
return imgDiv
};
MyDyanmicEditor.prototype.createElement=function(elementType){var ME=this;
var oDiv=document.createElement("div");
$(oDiv).attr("img-max-width","577");
$(oDiv).attr("img-max-width","590");
$(oDiv).addClass("block");
$(oDiv).css({margin:"0px","margin-top":"0px",overflow:"hidden",display:"block",position:"relative"});
$(oDiv).append(ME.iconPanel);
var table=document.createElement("table");
$(table).css({width:"100%"});
$(table).attr({border:"0px",cellpadding:"0px",cellspacing:"0px"});
var row=document.createElement("tr");
switch(elementType){case"HEADER":break;
case"TEXT":ME.unsavedChanges=true;
var div=document.createElement("div");
var textDiv=ME.createTextBlock();
$(div).append(textDiv);
var td=ME.createTableCell();
$(td).attr({colspan:"2"});
$(td).append(div);
$(row).append(td);
$(table).attr("blockType","ONLY_TEXT");
break;
case"TEXT_WITH_IMAGE":case"IMAGE_WITH_TEXT":ME.unsavedChanges=true;
$(oDiv).attr("img-max-width","286");
var div=document.createElement("div");
var textDiv=ME.createTextBlock();
var imgDiv=ME.createImageBlock();
$(div).append(textDiv);
$(div).append(imgDiv);
var td1=ME.createTableCell();
var td2=ME.createTableCell();
if(elementType=="TEXT_WITH_IMAGE"){$(textDiv).css("padding-right","10px");
$(td1).append(textDiv);
$(td2).append(imgDiv);
$(td1).css({"max-width":"75%","vertical-align":"top"});
$(td1).css({width:"75%"});
$(td2).css({"vertical-align":"top"})
}else{$(textDiv).css("padding-left","10px");
$(td1).append(imgDiv);
$(td2).append(textDiv);
$(td1).css({"vertical-align":"top"});
$(td2).css({"max-width":"75%",width:"75%","vertical-align":"top"})
}$(div).append("<div style='clear:both'></div>");
$(row).append(td1);
$(row).append(td2);
$(table).attr("blockType","IMAGE_AND_TEXT");
break;
case"IMAGE":ME.unsavedChanges=true;
var div=document.createElement("div");
var imgDiv=ME.createImageBlock();
$(div).append(imgDiv);
var td=ME.createTableCell();
$(td).append(div);
$(td).attr({colspan:"2"});
$(td).css({width:"600px"});
$(row).append(td);
$(table).attr("blockType","ONLY_IMAGE");
break;
case"IMAGE_2":ME.unsavedChanges=true;
$(oDiv).attr("img-max-width","286");
var textDiv=ME.createTextBlock();
$(textDiv).css({"max-width":"490px"});
var textDiv2=ME.createTextBlock();
$(textDiv2).css({"max-width":"490px"});
var imgDiv=ME.createImageBlock();
var imgDiv2=ME.createImageBlock();
var td1=ME.createTableCell();
var td2=ME.createTableCell();
var tdExtra1=ME.createTableCell();
var tdExtra2=ME.createTableCell();
var td3=ME.createTableCell();
var td4=ME.createTableCell();
$(td1).append(imgDiv2);
$(td2).append(imgDiv);
$(td3).append(textDiv2);
$(td4).append(textDiv);
$(tdExtra1).append("&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;");
$(tdExtra2).append("&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;");
$(td1).css({"vertical-align":"top"});
$(td2).css({"vertical-align":"top"});
$(td3).css({width:"50%","vertical-align":"top"});
$(td4).css({width:"50%","vertical-align":"top"});
$(div).append("<div style='clear:both'></div>");
var imgRow=document.createElement("tr");
$(imgRow).append(td1);
$(imgRow).append(tdExtra1);
$(imgRow).append(td2);
$(table).append(imgRow);
$(row).append(td3);
$(row).append(tdExtra2);
$(row).append(td4);
$(table).attr("blockType","TWO_IMAGE");
break;
case"IMAGE_3":ME.unsavedChanges=true;
$(oDiv).attr("img-max-width","190");
var div=document.createElement("div");
var textDiv=ME.createTextBlock();
var textDiv2=ME.createTextBlock();
var textDiv3=ME.createTextBlock();
var imgDiv=ME.createImageBlock();
var imgDiv2=ME.createImageBlock();
var imgDiv3=ME.createImageBlock();
$(div).append(imgDiv);
$(div).append(imgDiv2);
$(div).append(imgDiv3);
var td1=ME.createTableCell();
var td2=ME.createTableCell();
var td3=ME.createTableCell();
var tdExtra1=ME.createTableCell();
var tdExtra2=ME.createTableCell();
var tdExtra3=ME.createTableCell();
var tdExtra4=ME.createTableCell();
var td4=ME.createTableCell();
var td5=ME.createTableCell();
var td6=ME.createTableCell();
$(td1).append(imgDiv);
$(td2).append(imgDiv2);
$(td3).append(imgDiv3);
$(td4).append(textDiv);
$(td5).append(textDiv2);
$(td6).append(textDiv3);
$(tdExtra1).append("&nbsp;&nbsp;&nbsp;&nbsp;");
$(tdExtra2).append("&nbsp;&nbsp;&nbsp;&nbsp;");
$(tdExtra3).append("&nbsp;&nbsp;&nbsp;&nbsp;");
$(tdExtra4).append("&nbsp;&nbsp;&nbsp;&nbsp;");
$(td1).css({"vertical-align":"top"});
$(td2).css({"vertical-align":"top"});
$(td3).css({"vertical-align":"top"});
$(td4).css({width:"33.3%","vertical-align":"top"});
$(td5).css({width:"33.3%","vertical-align":"top"});
$(td6).css({width:"33.3%","vertical-align":"top"});
var imgRow=document.createElement("tr");
$(imgRow).append(td1);
$(imgRow).append(tdExtra1);
$(imgRow).append(td2);
$(imgRow).append(tdExtra2);
$(imgRow).append(td3);
$(table).append(imgRow);
$(row).append(td4);
$(row).append(tdExtra3);
$(row).append(td5);
$(row).append(tdExtra4);
$(row).append(td6);
$(div).append("<div style='clear:both'></div>");
$(table).attr("blockType","THREE_IMAGE");
break;
case"CTA":ME.unsavedChanges=true;
pubObj.CTA_action.create(table);
break;
case"SOCIAL":ME.unsavedChanges=true;
pubObj.Social_action.create(table);
break;
case"DIVIDER":ME.unsavedChanges=true;
pubObj.Divider_action.create(table);
break;
case"FOOTER":ME.unsavedChanges=true;
if(!("[footer-element]",ME.$designDiv)[0]){return ME.createFooter(ME.opts.inputs.store)
}return"";
break
}$(table).append(row);
if($(this).find("hr").length>0){$(table).css("padding","0px")
}else{$(table).css("padding","8px")
}$(table).css("border-collapse","separate");
$(oDiv).append(table);
return oDiv
};
function WidgetPopup(){this.$mainDiv=null;
this.$currentEle=null;
this._mode=null;
this.$form=null;
this.opts=null;
this.loaded=false
}WidgetPopup.prototype={_init:function(div,opts){var ME=this;
ME.$mainDiv=$(div);
ME.$form=ME.$mainDiv.find("form");
ME.opts=opts;
ME._attachEvents();
ME._register()
},_attachEvents:function(){var ME=this;
console.log(ME.$mainDiv.find('[data-toggle="popover"]'));
ME.$mainDiv.find('[data-toggle="popover"]').popover({trigger:"hover"});
C$.jq(ME.$form).validate({submitHandler:function(){ME.onSubmit(ME.$form.serializeArray());
return false
}});
ME.$mainDiv.find("[cancel-btn]").click(function(){ME.onCancel()
})
},_register:function(){},_beforeOpen:function(){},afterLoad:function(_cb){var ME=this;
if(ME.loaded!=true){window.setTimeout(function(){ME.afterLoad.call(ME,_cb)
},150);
return
}else{_cb()
}},onCancel:function(){var ME=this;
if(ME._mode=="create"){ME.$currentEle.remove()
}},onSubmit:function(){},_open:function(){var ME=this;
ME.$mainDiv.modal("show")
},hide:function(){var ME=this;
ME.$mainDiv.modal("hide")
}};
function CTA_Modal(ele,opts){this.$controlsSpan=null;
this.MAX_CTAS=3;
this._init(ele,opts);
this.$btnTmpl=this.$mainDiv.find('[tmpl="cta_tmpl"]').remove();
this.$controlsSpan=this.$mainDiv.find("[controls-span]");
this.$btnTmpl.removeAttr("tmpl").show();
this.loaded=true
}CTA_Modal.prototype=new WidgetPopup();
CTA_Modal.prototype.constructor=CTA_Modal;
CTA_Modal.prototype._register=function(){var ME=this;
var $blk=ME.$mainDiv.find("[cta-design-blk]:first");
ME._registerEvents($blk);
ME.$mainDiv.on("click","[action]",function(){var action=$(this).attr("action");
switch(action){case"add-cta":ME.addCTA();
break;
case"remove-cta":ME.removeCTA();
break
}})
};
CTA_Modal.prototype.removeCTA=function(){var ME=this;
var $blk=ME.$mainDiv.find("[cta-design-blk]:last");
$blk.remove();
ME._updateLayout();
return $blk
};
CTA_Modal.prototype._extractData=function(ele){var ME=this;
var $ele=$(ele);
var $tab=$ele.find("table");
var $a=$tab.find("a");
var data={};
var textColor=!$tab.css("color")?$a.css("color"):$tab.css("color");
data.link=$ele.find("a").attr("href");
data.align=$ele.css("text-align");
data.buttonColor=$tab.css("background-color");
data.textColor=textColor;
data.buttonText=$tab.find("a").text();
return data
};
CTA_Modal.prototype.create=function(ele){var ME=this;
ME._mode="create";
ME.$currentEle=$(ele);
ME.$mainDiv.find("[cta-design-blk]:gt(0)").remove();
ME._updateLayout();
ME._open()
};
CTA_Modal.prototype.edit=function(ele){var ME=this;
ME._mode="edit";
ME.$currentEle=$(ele).parents("table:first");
var cnt=ME.$currentEle.find(".CTA_Btn_holder").length;
ME.$mainDiv.find("[cta-design-blk]:gt("+(cnt-1)+")").remove();
ME._updateLayout();
ME.$currentEle.find(".CTA_Btn_holder").each(function(ind){ME.setData(ME.$mainDiv.find("[cta-design-blk]:eq("+ind+")"),ME._extractData(this))
});
ME._open()
};
CTA_Modal.prototype.setData=function($blk,data){var ME=this;
if($blk[0]==undefined){$blk=ME.addCTA()
}$blk.find("[btn-group=align]").button("setValue",data.align);
$blk.find(":input[name=link]").val(data.link);
$blk.find(":input[name=buttonText]").val(data.buttonText);
var $txtColor=$blk.find(":input[name=textColor]").parent();
$txtColor.colorpicker("setValue",data.textColor);
var $btnColor=$blk.find(":input[name=buttonColor]").parent();
$btnColor.colorpicker("setValue",data.buttonColor)
};
CTA_Modal.prototype.getData=function(blk){var ME=this;
var $blk=$(blk);
var data={};
data.align=$blk.find("[btn-group=align] .btn.active :input").val();
data.buttonColor=$blk.find(":input[name=buttonColor]").val();
data.textColor=$blk.find(":input[name=textColor]").val();
data.link=$blk.find(":input[name=link]").val();
data.buttonText=$blk.find(":input[name=buttonText]").val();
return data
};
CTA_Modal.prototype._generateCTA=function(data){var ME=this;
var $ele=ME.$btnTmpl.clone();
$ele.css("text-align",data.align);
$ele.find("a").attr("href",data.link);
$ele.find("table").css({"background-color":data.buttonColor,color:data.textColor});
var $innerA=$ele.find("table a");
$innerA.text(data.buttonText);
return $ele
};
CTA_Modal.prototype.onSubmit=function(data){var ME=this;
var _$row=$("<tr/>");
var total=ME.$mainDiv.find("[cta-design-blk]").length-1;
ME.$mainDiv.find("[cta-design-blk]").each(function(ind){_$row.append($("<td/>").append(ME._generateCTA(ME.getData(this))));
if(total>ind){_$row.append("<td>&nbsp;&nbsp;&nbsp;&nbsp;</td>")
}});
ME.$currentEle.empty().append(_$row);
ME.hide()
};
CTA_Modal.prototype._registerEvents=function(blk){$(blk).find(".colorpicker").colorpicker({format:"hex"})
};
CTA_Modal.prototype._updateLayout=function(){var ME=this;
var cnt=ME.$mainDiv.find("[cta-design-blk]").length;
ME.$controlsSpan.find("[action]").show();
if(cnt>=ME.MAX_CTAS){ME.$controlsSpan.find("[action=add-cta]").hide()
}else{if(cnt==1){ME.$controlsSpan.find("[action=remove-cta]").hide()
}}var $blks=ME.$mainDiv.find("[cta-design-blk]");
$blks.removeClass(function(index,css){return(css.match(/\bcol-md-\S+/g)||[]).join(" ")
}).addClass("col-md-"+(12/cnt))
};
CTA_Modal.prototype.addCTA=function(){var ME=this;
var $blk=ME.$mainDiv.find("[cta-design-blk]:last");
var $row=$blk.parent("div");
$blk=$blk.clone();
ME._registerEvents($blk);
$row.removeClass("cols-*");
$row.append($blk);
ME._updateLayout();
return $blk
};
function createForm1(){var form='<div class="control-group"><label class="control-label" for="align">Alignment</label><input type="hidden" name="align" value="center" required />';
form+='<div class="controls"><div class="btn-group" data-toggle="buttons-radio"><button type="button" feedVal="left" class="alignBtn btn btn-primary">Left</button><button type="button" feedVal="center" class="alignBtn btn btn-primary active">Middle</button>';
form+='<button type="button" feedVal="right" class="alignBtn btn btn-primary">Right</button></div> &nbsp;&nbsp;&nbsp;<span id="AddSecondCTA" style="cursor: pointer" title="Add One More CTA">';
form+='<i class="icon-plus-sign icon-white"></i></span><span style="visibility: hidden; cursor: pointer "><i class="icon-minus-sign icon-white"></i></span></div></div>';
form+='<div class="control-group"><label class="control-label" for="align">Button Color</label><input type="hidden" name="color" value="btn-default" required /><div class="controls"><div class="input-append color colorpicker" data-color="rgb(255, 255, 255)">';
form+='<input type="text" class="span5" name="btncolor" value=""><span class="add-on"><i style="background-color: rgb(255, 255, 255);"></i></span></div></div></div>';
form+='<div class="control-group"><label class="control-label" for="align">Text Color</label><input type="hidden" name="color" value="btn-default" required /><div class="controls"><div class="input-append color colorpicker" data-color="rgb(255, 255, 255)"><input type="text" class="span5" name="txtcolor" value="">';
form+='<span class="add-on"><i style="background-color: rgb(255, 255, 255);"></i></span></div></div></div><div class="control-group"><label class="control-label" for="link">Link</label><div class="controls"><input name="link" type="text" placeholder="http://canvass.in" required style="width: 157px;"/></div>';
form+='</div><div class="control-group"><label class="control-label" for="caption">Button Text</label><div class="controls"><input name="caption" type="text" placeholder="Text on button" required style="width: 157px;"/></div></div>';
return form
}function createForm2(){var form='<div class="control-group"><label class="control-label" for="align">Alignment</label><input type="hidden" name="align" value="center" required /><div class="controls">';
form+='<div class="btn-group" data-toggle="buttons-radio"><button type="button" feedVal="left" class="alignBtn btn btn-primary">Left</button><button type="button" feedVal="center" class="alignBtn btn btn-primary active">Middle</button>';
form+='<button type="button" feedVal="right" class="alignBtn btn btn-primary">Right</button></div> &nbsp;&nbsp;&nbsp;<span id="AddThirdCTA" style="cursor: pointer" "title="Add One More CTA"><i class="icon-plus-sign icon-white"></i></span>';
form+='&nbsp;<span style="cursor: pointer; visibility:visible;" id="RemoveSecondCTA"><i class="icon-minus-sign icon-white"></i></span></div></div><div class="control-group"><label class="control-label" for="align">Button Color</label><input type="hidden" name="color" value="btn-default" required />';
form+='<div class="controls"><div class="input-append color colorpicker" data-color="rgb(255, 255, 255)"><input type="text" class="span5" name="btncolor" value=""><span class="add-on"><i style="background-color: rgb(255, 255, 255);"></i></span></div></div></div><div class="control-group">';
form+='<label class="control-label" for="align">Text Color</label><input type="hidden" name="color" value="btn-default" required /><div class="controls"><div class="input-append color colorpicker" data-color="rgb(255, 255, 255)"><input type="text" class="span5" name="txtcolor" value="">';
form+='<span class="add-on"><i style="background-color: rgb(255, 255, 255);"></i></span></div></div></div><div class="control-group"><label class="control-label" for="link">Link</label><div class="controls"><input name="link" type="text" placeholder="http://canvass.in" required style="width: 157px;"/>';
form+='</div></div><div class="control-group"><label class="control-label" for="caption">Button Text</label><div class="controls"><input name="caption" type="text" placeholder="Text on button" required style="width: 157px;"/></div></div>';
return form
}function createForm3(){var form='<div class="control-group"><label class="control-label" for="align">Alignment</label><input type="hidden" name="align" value="center" required /><div class="controls">';
form+='<div class="btn-group" data-toggle="buttons-radio"><button type="button" feedVal="left" class="alignBtn btn btn-primary">Left</button><button type="button" feedVal="center" class="alignBtn btn btn-primary active">Middle</button>';
form+='<button type="button" feedVal="right" class="alignBtn btn btn-primary">Right</button></div>&nbsp;&nbsp;&nbsp;<span style="cursor: pointer " id="RemoveThirdCTA"><i class="icon-minus-sign icon-white"></i></span></div></div><div class="control-group"><label class="control-label" for="align">Button Color</label><input type="hidden" name="color" value="btn-default" required />';
form+='<div class="controls"><div class="input-append color colorpicker" data-color="rgb(255, 255, 255)"><input type="text" class="span5" name="btncolor" value=""><span class="add-on"><i style="background-color: rgb(255, 255, 255);"></i></span></div></div></div><div class="control-group">';
form+='<label class="control-label" for="align">Text Color</label><input type="hidden" name="color" value="btn-default" required /><div class="controls"><div class="input-append color colorpicker" data-color="rgb(255, 255, 255)"><input type="text" class="span5" name="txtcolor" value="">';
form+='<span class="add-on"><i style="background-color: rgb(255, 255, 255);"></i></span></div></div></div><div class="control-group"><label class="control-label" for="link">Link</label><div class="controls"><input name="link" type="text" placeholder="http://canvass.in" required style="width: 157px;"/>';
form+='</div></div><div class="control-group"><label class="control-label" for="caption">Button Text</label><div class="controls"><input name="caption" type="text" placeholder="Text on button" required style="width: 157px;"/></div></div>';
return form
}function SocialWidget(ele,opts){this.images={fb:{s:"https://s3-ap-southeast-1.amazonaws.com/app-res/img/fb_s.png",r:"https://s3-ap-southeast-1.amazonaws.com/app-res/img/fb_r.png"},tw:{s:"https://s3-ap-southeast-1.amazonaws.com/app-res/img/ttr_s.png",r:"https://s3-ap-southeast-1.amazonaws.com/app-res/img/ttr_r.png"},li:{s:"https://s3-ap-southeast-1.amazonaws.com/app-res/img/li_s.png",r:"https://s3-ap-southeast-1.amazonaws.com/app-res/img/li_r.png"},gp:{s:"https://s3-ap-southeast-1.amazonaws.com/app-res/img/google_s.png",r:"https://s3-ap-southeast-1.amazonaws.com/app-res/img/google_r.png"},ig:{s:"https://s3-ap-southeast-1.amazonaws.com/app-res/img/insta_s.png",r:"https://s3-ap-southeast-1.amazonaws.com/app-res/img/insta_r.png"},pr:{s:"https://s3-ap-southeast-1.amazonaws.com/app-res/img/pinterest_s.png",r:"https://s3-ap-southeast-1.amazonaws.com/app-res/img/pinterest_r.png"}};
this._init(ele,opts);
this.$outerTmpl=this.$mainDiv.find('[tmpl="social_tmpl"]').remove();
this.$linkTmpl=this.$mainDiv.find('[tmpl="link_tmpl"]').remove();
this.$outerTmpl.removeAttr("tmpl");
this.$linkTmpl.removeAttr("tmpl");
this.SAVED_LINKS={};
this.loadSocialLinks()
}SocialWidget.prototype=new WidgetPopup();
SocialWidget.prototype.constructor=SocialWidget;
SocialWidget.prototype._register=function(_cb){var ME=this;
ME.$mainDiv.on("change",'[name="iconType"]',function(){var $ele=$(this);
ME._updatePreview($ele.val())
});
ME.$mainDiv.on("change","[link-type] [type=checkbox]",function(){var $ele=$(this);
var $div=$ele.closest("[link-type]");
if($ele.is(":checked")){$div.removeClass("disable")
}else{$div.addClass("disable")
}});
ME.$mainDiv.on("focus","[link-type] :input[link]",function(){var $ele=$(this);
var $div=$ele.closest("[link-type]");
if($div.hasClass("disable")){$div.removeClass("disable");
$div.find("[type=checkbox]").attr("checked","checked").trigger("change")
}});
ME._updatePreview()
};
SocialWidget.prototype._updatePreview=function(mode){var ME=this;
mode=!mode?"round":mode;
var prop=mode=="round"?"r":"s";
ME.$mainDiv.find("[link-type]").each(function(){var $ele=$(this);
var type=$ele.attr("link-type");
var $img=$ele.find("[preview]");
$img.attr("src",ME.images[type][prop]).css("height","20px")
})
};
SocialWidget.prototype.setData=function(data){var ME=this;
ME.$mainDiv.find("[list-type]").addClass("disable");
ME.$mainDiv.find("[list-type] :input[type=checkbox]").removeAttr("checked");
$.each(ME.SAVED_LINKS,function(key,val){var $input=ME.$mainDiv.find('[name="'+key+'"]');
var $d=$input.closest("[link-type]");
$input.val(val)
});
var links=data.links;
$.each(links,function(key,val){var $input=ME.$mainDiv.find('[name="'+key+'"]');
var $d=$input.closest("[link-type]");
$d.removeClass("disable");
$d.find("input[type=checkbox]").attr("checked","checked");
$input.val(val)
});
ME.$mainDiv.find('[btn-group="align"]').button("setValue",data.align);
ME.$mainDiv.find('[btn-group="iconType"]').button("setValue",data.iconType)
};
SocialWidget.prototype.getData=function(){var ME=this;
var links={};
ME.$mainDiv.find("[link-type]:not(.disable)").each(function(){var $input=$(this).find(":input[link]");
links[$input.attr("name")]=$input.val()
});
var data={links:links,align:ME.$mainDiv.find('[btn-group="align"] .btn.active :input').val(),iconType:ME.$mainDiv.find('[btn-group="iconType"] .btn.active :input').val()};
return data
};
SocialWidget.prototype.onSubmit=function(){var ME=this;
var data=ME.getData();
if(data.links&&!$.isEmptyObject(data.links)){var _$row=$("<tr/>");
_$row.append($("<td/>").append(ME._generate(data)));
ME.$currentEle.empty().append(_$row);
ME.hide();
ME._saveLinks(data.links)
}else{C$.notifier.warning("Please select atleast one social link")
}};
SocialWidget.prototype._saveLinks=function(newLinks){var ME=this;
var changed=false;
if(newLinks){$.each(newLinks,function(key,val){if(ME.SAVED_LINKS[key]!=val){changed=true;
ME.SAVED_LINKS[key]=val
}})
}if(changed){C$.get("/account/util/xhr/set-social-urls",{links:JSON.stringify(ME.SAVED_LINKS)},function(data){console.log(data);
switch(data.status){case"SUCCESS":}})
}else{}};
SocialWidget.prototype._generate=function(data){var ME=this;
var $blk=ME.$outerTmpl.clone();
$blk.attr("icon-type",data.iconType);
$blk.css("text-align",data.align);
var iconT=data.iconType=="round"?"r":"s";
var links=data.links;
$.each(links,function(key,val){var $link=ME.$linkTmpl.clone();
$link.attr("href",val);
var imgSrc="";
switch(key){case"facebookUrl":$link.addClass("fbBtn");
imgSrc=ME.images.fb[iconT];
break;
case"twitterUrl":$link.addClass("ttrBtn");
imgSrc=ME.images.tw[iconT];
break;
case"linkedinUrl":$link.addClass("liBtn");
imgSrc=ME.images.li[iconT];
break;
case"googleUrl":$link.addClass("googleBtn");
imgSrc=ME.images.gp[iconT];
break;
case"instagramUrl":$link.addClass("instaBtn");
imgSrc=ME.images.ig[iconT];
break;
case"pinterestUrl":$link.addClass("pinterestBtn");
imgSrc=ME.images.pr[iconT];
break
}$link.find("img").attr("src",imgSrc);
$blk.append($link)
});
return $blk
};
SocialWidget.prototype._extractData=function(ele){var $ele=$(ele).find(".Social_Btns_holder");
var data={};
var links={};
$ele.find("a.element").each(function(){var $a=$(this);
var _key="";
if($a.hasClass("fbBtn")){_key="facebookUrl"
}else{if($a.hasClass("ttrBtn")){_key="twitterUrl"
}else{if($a.hasClass("liBtn")){_key="linkedinUrl"
}else{if($a.hasClass("googleBtn")){_key="googleUrl"
}else{if($a.hasClass("instaBtn")){_key="instagramUrl"
}else{if($a.hasClass("pinterestBtn")){_key="pinterestUrl"
}}}}}}links[_key]=$a.attr("href")
});
var iconType=$ele.attr("icon-type");
var align=$ele.css("text-align");
iconType=(!iconType||iconType=="")?"round":iconType;
align=(!align||align=="")?"center":align;
data.links=links;
data.iconType=iconType;
data.align=align;
return data
};
SocialWidget.prototype.loadSocialLinks=function(_cb){var ME=this;
C$.get("/account/util/xhr/get-social-urls",{},function(data){switch(data.status){case"SUCCESS":ME.SAVED_LINKS=data.data;
ME.loaded=true
}if(_cb){_cb()
}})
};
SocialWidget.prototype.edit=function(ele){var ME=this;
ME._mode="edit";
ME.$currentEle=$(ele).parents("table:first");
ME._open();
ME.setData(ME._extractData(ME.$currentEle))
};
SocialWidget.prototype.create=function(ele){var ME=this;
ME._mode="create";
ME.$currentEle=$(ele);
ME._open();
ME.setData({align:"center",iconType:"round",links:{}})
};
function DividerWidget(ele,opts){this._init(ele,opts)
}DividerWidget.prototype=new WidgetPopup();
DividerWidget.prototype.constructor=DividerWidget;
DividerWidget.prototype._register=function(){};
DividerWidget.prototype.setData=function(data){var ME=this;
ME.$mainDiv.find('[btn-group="type"]').button("setValue",data.type);
ME.$mainDiv.find(":input[name=size]").val(data.size)
};
DividerWidget.prototype.getData=function(){var ME=this;
var data={type:ME.$mainDiv.find('[btn-group="type"] .btn.active :input').val(),size:ME.$mainDiv.find(":input[name=size]").val()};
return data
};
DividerWidget.prototype.onSubmit=function(){var ME=this;
var data=ME.getData();
var _$row=$("<tr/>");
_$row.append(ME._generate(data));
ME.$currentEle.empty().append(_$row);
ME.hide()
};
DividerWidget.prototype._generate=function(data){var ME=this;
var $td=$("<td/>");
var $ele=$('<div dividerType="'+data.type+'"/>');
switch(data.type){case"line":$ele.append('<hr style="border-right: 583px solid; border-top: medium none; border-left: medium none; border-bottom: medium none; margin-right: 0px; height:'+data.size+'px;">');
break;
case"space":$ele.height(data.size);
$td.height(data.size);
break
}$td.append($ele);
return $td
};
DividerWidget.prototype._extractData=function(ele){var type=$(ele).find("[dividertype]").attr("dividerType");
type=!type?"line":type;
var data={};
var size;
switch(type){case"line":size=parseInt(""+$(ele).find("hr").css("height"));
break;
case"space":size=parseInt(""+$(ele).find("dividertype").closest("td").css("height"));
break
}data.type=type;
data.size=size;
return data
};
DividerWidget.prototype.edit=function(ele){var ME=this;
ME._mode="edit";
ME.$currentEle=$(ele).parents("table:first");
ME.setData(ME._extractData(ME.$currentEle));
ME._open()
};
DividerWidget.prototype.create=function(ele){var ME=this;
ME._mode="create";
ME.$currentEle=$(ele);
M